<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>CEMS - 장비 통합 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>try{if(window.matchMedia&&window.matchMedia('(prefers-reduced-motion: reduce)').matches&&window.Chart&&Chart.defaults){Chart.defaults.animation=false;}}catch(e){}</script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Rubik+Distressed&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .logo-text { font-family: 'Rubik Distressed', 'Noto Sans KR', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif; letter-spacing: 0.02em; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 320px; max-height: 40vh; }
        @media (max-width: 768px) { .chart-container { height: 280px; } }
        .sidebar-icon { width: 24px; height: 24px; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .active-nav { background-color: #4338ca; color: white; }
        .nav-item:hover { background-color: #4f46e5; color: white; }
        .submenu { background-color: #1e293b; }
        .submenu .nav-item { padding-left: 2rem; }
        .submenu .nav-item:hover { background-color: #334155; }
        .submenu-toggle { transition: transform 0.2s; }
        .submenu-toggle.rotated { transform: rotate(180deg); }
        .equipment-tab.active {
            border-bottom-color: #4338ca;
            color: #4338ca;
        }
        .equipment-tab-content { display: none; }
        .equipment-tab-content:first-child { display: block; }
        .equipment-tab.active {
            border-bottom-color: #4338ca;
            color: #4338ca;
        }
        
        /* 모달 중앙 정렬 강화 */
        #purchase-request-modal {
            display: none !important;
            align-items: center;
            justify-content: center;
        }
        
        #purchase-request-modal.show {
            display: flex !important;
        }
        
        #purchase-request-modal .bg-white {
            margin: 0 auto;
            transform: none;
            position: relative;
            left: 0;
            right: 0;
        }
        
        /* 사이드바 너비를 고려한 중앙 정렬 */
        @media (min-width: 768px) {
            #purchase-request-modal .bg-white {
                margin-left: auto;
                margin-right: auto;
                transform: translateX(0);
            }
        }
        
        /* 물품 주문 내역서 탭 스타일 */
        .order-tab-content {
            display: none;
        }
        
        .order-tab-content.active {
            display: block;
        }
        
        .order-tab-btn {
            color: #64748b;
            background-color: transparent;
        }
        
        .order-tab-btn.active {
            color: #1e293b;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* 견적서 A4 전용 레이아웃 */
        :root { --quote-side-margin: 15%; }
        #quote-print.quote-sheet { 
            width: calc(100% - (2 * var(--quote-side-margin))); 
            margin-left: var(--quote-side-margin); 
            margin-right: var(--quote-side-margin); 
            color: #111; 
        }
        #quote-print .quote-title { font-size: 28px; font-weight: 800; letter-spacing: 2px; }
        #quote-print .quote-table { width: 100%; border-collapse: collapse; }
        #quote-print .quote-table th, #quote-print .quote-table td { border: 1px solid #2f2f2f; padding: 6px 8px; }
        #quote-print .quote-table thead th { background: #f3f6fb; }
        #quote-print .thin { border-color: #616161; }
        #quote-print .bank-line { text-align: center; font-size: 12px; margin-top: 10px; }
        #quote-print .remarks-block { border-top: 1px solid #2f2f2f; height: 45mm; margin-top: 8px; }

        /* 인쇄용 스타일 */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: #fff !important; }
            nav, .sidebar, .order-tab-btn, .nav-item, #equipment-detail-modal, #purchase-request-modal { display: none !important; }
            #quote-modal { position: static !important; inset: auto !important; background: transparent !important; box-shadow: none !important; }
            #quote-modal > div { box-shadow: none !important; border: 0 !important; }
            #quote-print { 
                width: calc(100% - (2 * var(--quote-side-margin))); 
                margin-left: var(--quote-side-margin); 
                margin-right: var(--quote-side-margin);
            }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }

        /* 접근성 유틸리티 */
        .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
        .skip-link { position:absolute; top:0; left:0; background:#000; color:#fff; padding:8px 12px; transform:translateY(-120%); transition:transform .2s ease; z-index:1000; }
        .skip-link:focus { transform:translateY(0); outline:2px solid #fff; outline-offset:2px; }
        :focus-visible { outline:3px solid #ffbf47; outline-offset:2px; }
        @media (prefers-reduced-motion: reduce) {
            * { scroll-behavior:auto; transition:none !important; animation:none !important; }
        }
    </style>
</head>
<body class="bg-slate-100">
    <a href="#main" class="skip-link">본문 바로가기</a>
    <div class="flex h-screen">
        <nav class="w-20 md:w-64 bg-slate-800 text-white flex flex-col" role="navigation" aria-label="사이드바">
            <div class="flex items-center justify-center md:justify-start md:pl-6 h-20 border-b border-slate-700">
                <span class="hidden md:block ml-1 text-4xl font-extrabold tracking-wide logo-text">
                    <span style="color:#3B82F6;">C</span><span style="color:#FFFFFF;">E</span><span style="color:#3B82F6;">M</span><span style="color:#FFFFFF;">S</span>
                </span>
            </div>
            <ul class="flex-grow">
                <li class="nav-item active-nav p-4 md:pl-6 flex items-center cursor-pointer" onclick="switchView('dashboard')">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span class="hidden md:block ml-4">대시보드</span>
                </li>
                <li class="nav-item p-4 md:pl-6 flex items-center cursor-pointer" onclick="switchView('equipment'); toggleSubmenu('equipment-menu')">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
                    <span class="hidden md:block ml-4">장비</span>
                    <svg class="sidebar-icon ml-auto submenu-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </li>
                <ul id="equipment-menu" class="submenu hidden">
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchEquipmentTab('status')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="hidden md:block ml-4">현황</span>
                    </li>
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchEquipmentTab('repair')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="hidden md:block ml-4">수리</span>
                    </li>
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchEquipmentTab('education')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        <span class="hidden md:block ml-4">교육</span>
                    </li>
                </ul>
                <li class="nav-item p-4 md:pl-6 flex items-center cursor-pointer" onclick="toggleSubmenu('alarm-menu')">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4 19h6v-6H4v6zM4 5h6V4a1 1 0 00-1-1H5a1 1 0 00-1 1v1zm0 6h6v-1H4v1zm0 6h6v-1H4v1z"></path></svg>
                    <span class="hidden md:block ml-4">알림</span>
                    <svg class="sidebar-icon ml-auto submenu-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </li>
                <ul id="alarm-menu" class="submenu hidden">
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchView('alarm-equipment')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <span class="hidden md:block ml-4">장비</span>
                    </li>
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchView('alarm-accounting')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="hidden md:block ml-4">회계</span>
                    </li>
                </ul>
                <li class="nav-item p-4 md:pl-6 flex items-center cursor-pointer" onclick="toggleSubmenu('accounting-menu')">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span class="hidden md:block ml-4">회계</span>
                    <svg class="sidebar-icon ml-auto submenu-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </li>
                <ul id="accounting-menu" class="submenu hidden">
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchView('accounting-purchase-request')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                        <span class="hidden md:block ml-4">물품구매요구서</span>
                    </li>
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchView('accounting-quote')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="hidden md:block ml-4">견적 발행</span>
                    </li>
                    <li class="nav-item p-4 md:pl-12 flex items-center cursor-pointer" onclick="switchView('accounting-transaction')">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="hidden md:block ml-4">거래명세서 발행</span>
                    </li>
                    
                </ul>
            </ul>
        </nav>
        <main id="main" class="flex-1 p-6 md:p-10 overflow-y-auto" role="main" tabindex="-1">
            <section id="dashboard-view" class="view-section">
                <h1 class="text-3xl font-bold text-slate-800">청명장비 통합대시보드</h1>
                <p class="mt-2 text-slate-600">현재까지 구축된 DB 데이터를 기반으로 장비 운영 현황을 종합적으로 파악합니다.</p>
                
                <!-- 통계 카드 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 mt-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-indigo-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-slate-500">총 장비</p>
                            <p class="text-2xl font-bold text-slate-800"><span id="total-equipment">0 대</span></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-green-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-slate-500">가동률</p>
                            <p class="text-2xl font-bold text-slate-800"><span id="total-repairs">0%</span></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-red-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-slate-500">업체 수리중</p>
                            <p class="text-2xl font-bold text-slate-800"><span id="match-rate">0 대</span></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-slate-500">장기 미사용률</p>
                            <p class="text-2xl font-bold text-slate-800"><span id="total-cost">0%</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- 차트 섹션 -->
                <div class="mt-8 grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md" role="region" aria-labelledby="equipmentChartTitle">
                        <h3 id="equipmentChartTitle" class="text-lg font-semibold text-slate-700">품목계열별 가동률</h3>
                        <div class="chart-container mt-4">
                            <canvas id="equipmentChart" role="img" aria-label="품목계열별 가동률 도넛 차트">그래프를 표시할 수 없는 환경입니다. 표를 참고하세요.</canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md" role="region" aria-labelledby="repairsChartTitle">
                        <h3 id="repairsChartTitle" class="text-lg font-semibold text-slate-700">수리업체별 수리 건수</h3>
                        <div class="chart-container mt-4">
                            <canvas id="repairsChart" role="img" aria-label="수리업체별 수리 건수 막대 차트">그래프를 표시할 수 없는 환경입니다. 표를 참고하세요.</canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 하단 섹션 -->
                <div class="mt-8 grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <!-- 좌측: 차주 품목계열별 예상 가동 대수 -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">다음주 예상 가동률</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <caption class="sr-only">다음주 예상 가동률 표</caption>
                                <thead>
                                    <tr class="border-b border-slate-200">
                                        <th scope="col" class="text-left py-2">품목계열</th>
                                        <th scope="col" class="text-center py-2">예상 가동 대수</th>
                                        <th scope="col" class="text-center py-2">현재 청명 위치 대수</th>
                                        <th scope="col" class="text-center py-2">가동률</th>
                                    </tr>
                                </thead>
                                <tbody id="next-week-uptime-body">
                                    <!-- 데이터가 여기에 로드됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 우측: 알림 미조치 섹션 -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4">알림 미조치 (건)</h3>
                        
                        <!-- 우선순위별 알림 카드 -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
                                <div class="text-2xl font-bold text-red-600" id="critical-alerts">1</div>
                                <div class="text-sm text-red-600">긴급</div>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-lg border border-orange-200">
                                <div class="text-2xl font-bold text-orange-600" id="high-alerts">2</div>
                                <div class="text-sm text-orange-600">높음</div>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <div class="text-2xl font-bold text-yellow-600" id="medium-alerts">3</div>
                                <div class="text-sm text-yellow-600">보통</div>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="text-2xl font-bold text-blue-600" id="low-alerts">1</div>
                                <div class="text-sm text-blue-600">낮음</div>
                            </div>
                        </div>
                        
                        <!-- 알림 상세 테이블 -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <caption class="sr-only">알림 미조치 목록</caption>
                                <thead>
                                    <tr class="border-b border-slate-200">
                                        <th scope="col" class="text-left py-2">알림시간</th>
                                        <th scope="col" class="text-left py-2">품목계열</th>
                                        <th scope="col" class="text-left py-2">알림내용</th>
                                        <th scope="col" class="text-center py-2">우선순위</th>
                                        <th scope="col" class="text-center py-2">상태</th>
                                    </tr>
                                </thead>
                                <tbody id="alerts-body">
                                    <!-- 알림 데이터가 여기에 로드됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                

                
                <!-- 이카운트 동기화 업데이트 정보 -->
                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-700">이카운트 동기화 상태</h3>
                            <p class="text-sm text-slate-500 mt-1">ERP 시스템과의 데이터 동기화 현황</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-4">
                                <div class="text-center">
                                    <p class="text-sm text-slate-500">마지막 동기화</p>
                                    <p class="text-sm font-medium text-slate-700" id="last-sync-time" aria-live="polite">로딩 중...</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-slate-500">동기화 상태</p>
                                    <span id="sync-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" aria-live="polite">
                                        <svg class="w-2 h-2 mr-1.5" fill="currentColor" viewBox="0 0 8 8">
                                            <circle cx="4" cy="4" r="3"/>
                                        </svg>
                                        대기 중
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 동기화 진행률 표시 -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between text-sm text-slate-600 mb-2">
                            <span>동기화 진행률</span>
                            <span id="sync-progress-text">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div id="sync-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- 동기화 로그 -->
                    <div class="mt-4 p-3 bg-slate-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-slate-700">최근 동기화 로그</span>
                            <button onclick="refreshSyncStatus()" class="text-xs text-blue-600 hover:text-blue-800">
                                새로고침
                            </button>
                        </div>
                        <div id="sync-log" class="text-xs text-slate-600 space-y-1">
                            <div>2025-01-27 15:30:00 - 동기화 시작</div>
                            <div>2025-01-27 15:30:15 - 장비 데이터 동기화 완료 (293건)</div>
                            <div>2025-01-27 15:30:30 - 수리 데이터 동기화 완료 (852건)</div>
                            <div>2025-01-27 15:30:45 - 동기화 완료</div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="equipment-view" class="view-section hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800">장비 관리</h1>
                        <p class="mt-2 text-slate-600">장비 현황, 수리, 교육을 통합 관리합니다.</p>
                    </div>
                </div>
                <div class="border-b border-slate-200 mb-6">
                    <nav class="flex space-x-8">
                                        <button class="equipment-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 active" onclick="switchEquipmentTab('status');">
                            현황
                        </button>
                        <button class="equipment-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300" onclick="switchEquipmentTab('repair')">
                            수리
                        </button>
                        <button class="equipment-tab py-2 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300" onclick="switchEquipmentTab('education')">
                            교육
                        </button>
                    </nav>
                </div>
                <div id="equipment-status" class="equipment-tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 좌측: 품목계열별 통계 -->
                        <div class="space-y-6">
                            <!-- 전체 재고 현황 -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">전체 재고 현황</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded">
                                    <span class="font-medium">총 장비 수</span>
                                        <span class="text-indigo-600 font-bold" id="total-equipment">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded">
                                    <span class="font-medium">가동 중</span>
                                        <span class="text-green-600 font-bold" id="operating-equipment">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded">
                                    <span class="font-medium">수리 중</span>
                                        <span class="text-red-600 font-bold" id="repair-equipment">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded">
                                    <span class="font-medium">대기 중</span>
                                        <span class="text-blue-600 font-bold" id="idle-equipment">0</span>
                                </div>
                            </div>
                            </div>
                            
                            <!-- 품목계열별 통계 -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">품목계열별 현황</h3>
                                
                                <!-- 통계 개요 카드 4개 -->
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" role="region" aria-labelledby="stats-overview-title">
                                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                        <div class="text-sm text-blue-600 font-medium">출장 총합</div>
                                        <div class="text-2xl font-bold text-blue-800" id="cardTravelTotal">-</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                        <div class="text-sm text-green-600 font-medium">수리 총합</div>
                                        <div class="text-2xl font-bold text-green-800" id="cardRepairTotal">-</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                        <div class="text-sm text-purple-600 font-medium">출장 보유 시리얼</div>
                                        <div class="text-2xl font-bold text-purple-800" id="cardSerialsTravel">-</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                        <div class="text-sm text-orange-600 font-medium">수리 보유 시리얼</div>
                                        <div class="text-2xl font-bold text-orange-800" id="cardSerialsRepair">-</div>
                                    </div>
                                </div>
                                
                                <!-- 시리얼별 출장/수리 회차 상위 50 테이블 -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h4 class="text-base font-semibold text-slate-700">시리얼별 출장/수리 회차 상위 50</h4>
                                        <div class="flex items-center gap-2 text-sm text-slate-500">
                                            <span id="repairs-overview-status">로딩 중...</span>
                                            <button onclick="loadRepairOverview()" class="px-2 py-1 text-xs bg-slate-100 text-slate-600 rounded hover:bg-slate-200" title="새로고침">
                                                🔄
                                            </button>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto max-h-80 overflow-y-auto border rounded">
                                        <table class="w-full text-sm" role="table" aria-labelledby="repairs-overview-table-title">
                                            <caption id="repairs-overview-table-title" class="sr-only">시리얼별 출장/수리 회차 상위 50</caption>
                                            <thead class="bg-slate-50 sticky top-0">
                                                <tr>
                                                    <th scope="col" class="text-left p-2 font-medium">순위</th>
                                                    <th scope="col" class="text-left p-2 font-medium">일련번호</th>
                                                    <th scope="col" class="text-left p-2 font-medium">출장(회)</th>
                                                    <th scope="col" class="text-left p-2 font-medium">수리(회)</th>
                                                    <th scope="col" class="text-left p-2 font-medium">최근일자</th>
                                                </tr>
                                            </thead>
                                            <tbody id="repairs-overview-body" aria-busy="true">
                                                <tr>
                                                    <td colspan="5" class="p-4 text-center text-slate-500">데이터를 불러오는 중...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- 기존 품목계열별 통계 -->
                                <div class="mt-6">
                                    <h4 class="text-base font-semibold text-slate-700 mb-3">품목계열별 상세 통계</h4>
                                    <div class="space-y-3 max-h-64 overflow-y-auto">
                                        <div id="category-stats-container">
                                            <!-- 품목계열별 통계가 여기에 동적으로 생성됩니다 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 우측: 장비 상세 정보 -->
                        <div class="space-y-6">
                            <!-- 검색 및 필터링 -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">장비 검색</h3>
                                <div class="mb-4 flex flex-col sm:flex-row gap-4">
                                    <div class="flex-1">
                                        <input type="text" id="equipment-search" placeholder="시리얼번호, 카테고리, 위치로 검색..." 
                                               class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                               onkeyup="renderEquipmentTable()">
                                    </div>
                                    <div class="sm:w-48">
                                        <select id="status-filter" onchange="renderEquipmentTable()" 
                                                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="all">전체 상태</option>
                                            <option value="가동 중">가동 중</option>
                                            <option value="수리 중">수리 중</option>
                                            <option value="대기 중">대기 중</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <span class="text-sm text-slate-600" id="equipment-result-count">총 0개 장비</span>
                                </div>
                            </div>
                            
                            
                            
                            <!-- 장비 목록 (품목계열별 구분) -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">장비 목록</h3>
                                
                                <!-- 품목계열별 탭 -->
                                <div class="mb-4">
                                    <div class="flex flex-wrap gap-2" id="product-series-tabs">
                                        <!-- 품목계열 탭이 여기에 동적으로 생성됩니다 -->
                                    </div>
                                </div>
                                
                                <!-- 장비 목록 테이블 -->
                                <div class="overflow-x-auto max-h-[420px] overflow-y-auto">
                                    <table class="w-full text-sm table-fixed">
                                        <colgroup>
                                            <col style="width:22%">
                                            <col style="width:28%">
                                            <col style="width:14%">
                                            <col style="width:26%">
                                            <col style="width:10%">
                                        </colgroup>
                                        <thead class="bg-slate-100">
                                            <tr>
                                                <th class="text-left p-2">일련번호</th>
                                                <th class="text-left p-2">품목계열</th>
                                                <th class="text-left p-2">상태</th>
                                                <th class="text-left p-2">현재위치</th>
                                                <th class="text-left p-2">작업</th>
                                            </tr>
                                        </thead>
                                        <tbody id="equipment-list-body">
                                            <!-- 장비 목록이 여기에 동적으로 생성됩니다 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 수리 탭 내용 -->
                <div id="equipment-repair" class="equipment-tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">수리 내역 관리</h3>
                        
                        <!-- 수리 통계 섹션 -->
                        <div id="repair-stats" class="mb-6">
                            <!-- 통계 정보가 여기에 동적으로 생성됩니다 -->
                        </div>
                        
                        <!-- 전체 수리 로그: 품목계열 필터 + 드래그 스크롤 테이블 -->
                        <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                <h3 class="text-lg font-semibold text-slate-800">전체 수리 로그</h3>
                                <div class="flex gap-3 flex-wrap">
                                    <select id="repair-category-filter" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[220px]">
                                        <option value="all">전체 품목계열</option>
                                    </select>
                                    <input id="repair-search-input" type="text" placeholder="일련번호/업체/유형/담당자/비고 검색" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[260px]">
                                    <select id="repair-company-filter" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[180px]">
                                        <option value="all">전체 업체</option>
                                    </select>
                                    <select id="repair-type-filter" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[180px]">
                                        <option value="all">전체 유형</option>
                                    </select>
                                    <select id="repair-sort-select" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="date_desc">날짜▼</option>
                                        <option value="date_asc">날짜▲</option>
                                        <option value="cost_desc">비용▼</option>
                                        <option value="cost_asc">비용▲</option>
                                    </select>
                                    <button id="repair-log-export-btn" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">CSV 내보내기</button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mb-2 text-sm text-slate-600">
                                <div class="flex items-center gap-2">
                                    <span>페이지 크기</span>
                                    <select id="repair-page-size" class="px-2 py-1 border border-slate-300 rounded">
                                        <option value="50">50</option>
                                        <option value="100" selected>100</option>
                                        <option value="200">200</option>
                                        <option value="500">500</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button id="repair-prev-page" class="px-2 py-1 border rounded">이전</button>
                                    <span id="repair-page-info">-</span>
                                    <button id="repair-next-page" class="px-2 py-1 border rounded">다음</button>
                                </div>
                            </div>
                            <div id="repair-log-scroll" class="drag-scroll overflow-x-auto border rounded">
                                <table class="w-full text-sm min-w-[1200px]">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="text-left p-2">수리일자</th>
                                            <th class="text-left p-2">일련번호</th>
                                            <th class="text-left p-2">품목계열</th>
                                            <th class="text-left p-2">수리업체</th>
                                            <th class="text-left p-2">담당자</th>
                                            <th class="text-left p-2">수리유형</th>
                                            <th class="text-left p-2">측정항목</th>
                                            <th class="text-left p-2">비용</th>
                                            <th class="text-left p-2">비고</th>
                                        </tr>
                                    </thead>
                                    <tbody id="repair-log-tbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 품목계열 대분류 및 상세 -->
                        <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">품목계열 대분류</h3>
                            <div class="grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
                                <div>
                                    <h4 class="text-sm font-semibold text-slate-700 mb-2">측정항목</h4>
                                    <div id="measurement-list" class="flex flex-col gap-2 max-h-80 overflow-y-auto"></div>
                                </div>
                                <div>
                                    <h4 class="text-sm font-semibold text-slate-700 mb-2">품목계열</h4>
                                    <div id="product-series-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                                </div>
                            </div>
                        </div>
                        <div id="repair-category-detail" class="bg-white p-6 rounded-lg shadow-md mt-4">
                            <h3 id="repair-category-title" class="text-lg font-semibold text-slate-800 mb-4">카테고리 상세</h3>
                            <div id="repair-category-stats" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4"></div>
                            <div class="flex flex-wrap items-center gap-3 mb-3">
                                <select id="category-company-filter" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[180px]">
                                    <option value="all">전체 업체</option>
                                </select>
                                <select id="category-type-filter" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[180px]">
                                    <option value="all">전체 유형</option>
                                </select>
                                <select id="category-serials-sort" class="px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="cost_desc">총비용▼</option>
                                    <option value="cost_asc">총비용▲</option>
                                    <option value="count_desc">건수▼</option>
                                    <option value="count_asc">건수▲</option>
                                    <option value="last_desc">최종수리▼</option>
                                    <option value="last_asc">최종수리▲</option>
                                </select>
                                <button id="category-export-btn" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">CSV 내보내기</button>
                            </div>
                            <div class="mb-3">
                                <h4 class="text-sm font-semibold text-slate-700">업체 분포</h4>
                                <ul id="repair-category-companies" class="list-disc pl-5 text-sm text-slate-700"></ul>
                            </div>
                            <div class="mb-4">
                                <canvas id="categoryMonthlyMiniChart" height="120" aria-label="월별 추이"></canvas>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm min-w-[680px]">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="text-left p-2">일련번호</th>
                                            <th class="text-left p-2">건수</th>
                                            <th class="text-left p-2">총비용</th>
                                            <th class="text-left p-2">첫 수리</th>
                                            <th class="text-left p-2">최종 수리</th>
                                        </tr>
                                    </thead>
                                    <tbody id="repair-category-serials-tbody"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 가시성: 월별/Top 통계 섹션 (db/stats_*.json 바인딩) -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">월별 수리 건수/비용</h3>
                                <canvas id="repairsMonthlyChart" aria-label="월별 수리 건수/비용"></canvas>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">업체별 총 수리비 Top</h3>
                                <canvas id="topCompaniesByCostChart" aria-label="업체별 총 수리비 Top"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">카테고리별 총 수리비 Top</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="text-left p-2">카테고리</th>
                                            <th class="text-left p-2">건수</th>
                                            <th class="text-left p-2">총비용</th>
                                            <th class="text-left p-2">평균</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topCategoriesBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">시리얼별 총 수리비 Top</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="text-left p-2">일련번호</th>
                                            <th class="text-left p-2">카테고리</th>
                                            <th class="text-left p-2">건수</th>
                                            <th class="text-left p-2">총비용</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topSerialsBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                                        </div>
                                        </div>
                
                <!-- 교육 탭 내용 -->
                <div id="equipment-education" class="equipment-tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">장비 교육 관리</h3>
                        <div class="mb-4">
                            <div class="flex gap-4 mb-4">
                                <button onclick="showEducationForm()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                    교육 등록
                                </button>
                                <button onclick="exportEducationData()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    데이터 내보내기
                                </button>
                                    </div>
                                </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="text-left p-2">날짜</th>
                                        <th class="text-left p-2">교육명</th>
                                        <th class="text-left p-2">참석자</th>
                                        <th class="text-left p-2">내용</th>
                                        <th class="text-left p-2">상태</th>
                                        <th class="text-left p-2">작업</th>
                                    </tr>
                                </thead>
                                <tbody id="education-table">
                                </tbody>
                            </table>
                            </div>
                    </div>
                </div>
            </section>
            
            <!-- 알림 탭들 -->
            <section id="alarm-equipment-view" class="view-section hidden">
                <div class="p-6 md:p-10">
                    <h1 class="text-3xl font-bold text-slate-800 mb-6">장비 알림</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-slate-800 mb-2">장기간 업체 입고(30일+) 알림</h3>
                        <p class="text-sm text-slate-600 mb-4">`equipment_db.json`의 최근 이동일 기준으로 30일 이상 업체에 머문 장비를 표시합니다.</p>
                        <div id="vendor-longstay-alerts" class="space-y-3"></div>
                    </div>
                    
                    <!-- 정도검사 알림 섹션 추가 -->
                    <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">정도검사 알림</h3>
                        <div id="calibration-alerts" class="space-y-4">
                            <!-- 정도검사 알림이 여기에 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="alarm-accounting-view" class="view-section hidden">
                <div class="p-6 md:p-10">
                    <h1 class="text-3xl font-bold text-slate-800 mb-6">회계 알림</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">회계 관련 알림</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-blue-800">견적 승인 대기</span>
    </div>
                                <span class="text-sm text-blue-600">2024-01-15</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 회계 탭들 -->
    <section id="accounting-purchase-request-view" class="view-section hidden">
        <div class="p-6 md:p-10">
            <h1 class="text-3xl font-bold text-slate-800 mb-6">물품구매요구서</h1>
            <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4 flex space-x-3">
                            <button onclick="showPurchaseRequestModal()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                구매요구서 작성
                            </button>
                            
                        </div>
                <table class="w-full text-sm">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="text-left p-2">요청번호</th>
                            <th class="text-left p-2">품목</th>
                            <th class="text-left p-2">수량</th>
                            <th class="text-left p-2">상태</th>
                            <th class="text-left p-2">작업</th>
                        </tr>
                    </thead>
                            <tbody id="purchase-request-table">
                            </tbody>
                </table>
            </div>
        </div>
    </section>
            
            <section id="accounting-quote-view" class="view-section hidden">
                <div class="p-6 md:p-10">
                    <h1 class="text-3xl font-bold text-slate-800 mb-6">견적 발행</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4 flex flex-col gap-3">
                            <div class="flex flex-wrap gap-3 items-center">
                                <button onclick="showQuoteForm()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                    견적서 작성
                                </button>
                                <label class="flex items-center gap-2 text-sm text-slate-700">
                                    <input id="toggle-import-help" type="checkbox" class="w-4 h-4">
                                    <span>구매요구서 불러오기 안내/버튼 표시</span>
                                </label>
                                <button id="btn-open-purchase-import" onclick="showPurchaseRequestSelector()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 hidden">
                                    구매요구서 선택 → 미리보기
                                </button>
                            </div>
                            <div id="import-help-panel" class="hidden bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-900">
                                <div class="font-semibold">구매요구서 → 견적서 매핑 규칙</div>
                                <div class="mt-1">품명→세부내용, 규격→제품번호, 수량→수량, 예상금액→단가, 납기→기본 30일</div>
                            </div>
                            <script>
                                (function(){
                                    const cb = document.getElementById('toggle-import-help');
                                    const panel = document.getElementById('import-help-panel');
                                    const btn = document.getElementById('btn-open-purchase-import');
                                    if (cb) {
                                        cb.addEventListener('change', function(){
                                            const on = !!this.checked;
                                            if (panel) panel.classList.toggle('hidden', !on);
                                            if (btn) btn.classList.toggle('hidden', !on);
                                        });
                                    }
                                })();
                            </script>
                        </div>
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="text-left p-2">견적번호</th>
                                    <th class="text-left p-2">고객명</th>
                                    <th class="text-left p-2">품목</th>
                                    <th class="text-left p-2">금액</th>
                                    <th class="text-left p-2">상태</th>
                                    <th class="text-left p-2">작업</th>
                                </tr>
                            </thead>
                            <tbody id="quote-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="accounting-transaction-view" class="view-section hidden">
                <div class="p-6 md:p-10">
                    <h1 class="text-3xl font-bold text-slate-800 mb-6">거래명세서 발행</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <button onclick="showTransactionForm()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                거래명세서 작성
                            </button>
                        </div>
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="text-left p-2">거래번호</th>
                                    <th class="text-left p-2">거래처</th>
                                    <th class="text-left p-2">품목</th>
                                    <th class="text-left p-2">수량</th>
                                    <th class="text-left p-2">단가</th>
                                    <th class="text-left p-2">작업</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            
            
            <!-- 자동완성 데이터리스트 -->
            <datalist id="product-name-list"></datalist>
            <datalist id="product-spec-list"></datalist>
            <datalist id="supplier-list"></datalist>
        </main>
    </div>

    <!-- 장비 상세 정보 모달 -->
    <div id="equipment-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <div class="bg-white rounded-lg shadow-xl w-full max-h-screen overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">장비 상세 정보</h2>
                        <button onclick="closeEquipmentDetailModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6" id="equipment-detail-modal-content">
                    <!-- 장비 상세 정보가 여기에 동적으로 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 물품구매요구서 모달 -->
    <div id="purchase-request-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center" style="display: none !important;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl max-h-screen overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">물품구매요구서</h2>
                        <button onclick="closePurchaseRequestModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="purchase-request-form" class="space-y-6">
                        <!-- 헤더 섹션 -->
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">작성일자</label>
                                        <input type="date" id="preparation-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">구입부서</label>
                                        <select id="purchasing-department" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                            <option value="">선택하세요</option>
                                            <option value="해양분석팀">해양분석팀</option>
                                            <option value="대기분석팀">대기분석팀</option>
                                            <option value="수질분석팀">수질분석팀</option>
                                            <option value="악취분석팀">악취분석팀</option>
                                            <option value="소음,진동 분석팀">소음,진동 분석팀</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">구입사유</label>
                                        <input type="text" id="purchase-reason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="구입사유를 입력하세요" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 승인 테이블 -->
                            <div class="ml-8">
                                <table class="border border-gray-300 text-sm">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="border border-gray-300 px-3 py-2 text-center">담당자</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">기술 책임자</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">품질 책임자</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">부사장</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">사장</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 text-center h-12"></td>
                                            <td class="border border-gray-300 px-3 py-2 text-center h-12"></td>
                                            <td class="border border-gray-300 px-3 py-2 text-center h-12"></td>
                                            <td class="border border-gray-300 px-3 py-2 text-center h-12"></td>
                                            <td class="border border-gray-300 px-3 py-2 text-center h-12"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 품목 리스트 테이블 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">품목 리스트</label>
                            <div class="overflow-x-auto">
                                <table class="w-full border border-gray-300 text-sm">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="border border-gray-300 px-3 py-2 text-center">품명</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">규격</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">수량</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">예상금액</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">공급대상업체</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">기타</th>
                                            <th class="border border-gray-300 px-3 py-2 text-center">작업</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-table-body">
                                        <tr class="item-row">
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input list="product-name-list" type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="품명">
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input list="product-spec-list" type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="규격">
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input type="number" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="수량" min="1">
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input type="number" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="예상금액" min="0">
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input list="supplier-list" type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="공급업체">
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="기타">
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">
                                                <button type="button" onclick="removeItemRow(this)" class="text-red-600 hover:text-red-800 px-2 py-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2">
                                <button type="button" onclick="addItemRow()" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                                    + 품목 추가
                                </button>
                            </div>
                        </div>

                        <!-- 합계 섹션 -->
                        <div class="flex justify-end">
                            <div class="w-64">
                                <table class="w-full border border-gray-300 text-sm">
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 bg-gray-50 font-medium">합계</td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input type="text" id="subtotal" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500 bg-transparent" readonly value="0원" data-value="0">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 bg-gray-50 font-medium">부가세</td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <input type="text" id="vat" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500 bg-transparent" readonly value="0원" data-value="0">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 bg-gray-50 font-medium">총금액</td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <div class="flex items-center">
                                                    <input type="text" id="total-amount" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500 bg-transparent" readonly value="0원" data-value="0">
                                                    <span class="ml-2 text-gray-600">₩</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 푸터 -->
                        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                            <div class="text-sm text-gray-500">CM-QP-04-F07</div>
                            <div class="text-sm text-gray-500">회사 청명기연환경</div>
                            <div class="text-sm text-gray-500">A4(210×297mm)</div>
                        </div>

                        <!-- 진행상황 표시 -->
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-medium text-gray-700">진행상황</h4>
                                <button type="button" onclick="simulateApproval()" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    승인 진행 시뮬레이션
                                </button>
                            </div>
                            <div class="grid grid-cols-5 gap-4 text-center">
                                <div class="approval-step" data-step="담당자">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-gray-200 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-xs text-gray-600">담당자</div>
                                    <div class="text-xs text-gray-500 mt-1">대기중</div>
                                </div>
                                <div class="approval-step" data-step="기술 책임자">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-gray-200 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-xs text-gray-600">기술 책임자</div>
                                    <div class="text-xs text-gray-500 mt-1">대기중</div>
                                </div>
                                <div class="approval-step" data-step="품질 책임자">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-gray-200 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-xs text-gray-600">품질 책임자</div>
                                    <div class="text-xs text-gray-500 mt-1">대기중</div>
                                </div>
                                <div class="approval-step" data-step="부사장">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-gray-200 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div class="text-xs text-gray-600">부사장</div>
                                    <div class="text-xs text-gray-500 mt-1">대기중</div>
                                </div>
                                <div class="approval-step" data-step="사장">
                                    <div class="w-12 h-12 mx-auto mb-2 bg-gray-200 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div class="text-xs text-gray-600">사장</div>
                                    <div class="text-xs text-gray-500 mt-1">대기중</div>
                                </div>
                            </div>
                        </div>

                        <!-- 버튼 -->
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="printPurchaseRequest()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2v4a2 2 0 002 2h6a2 2 0 002-2z"></path>
                                </svg>
                                인쇄
                            </button>
                            <button type="button" onclick="closePurchaseRequestModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                                취소
                            </button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                저장
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 견적서 모달 -->
    <div id="quote-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div id="quote-print" class="bg-white rounded-lg shadow-xl w-full max-w-7xl max-h-screen overflow-y-auto quote-sheet">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">견적서</h2>
                    <button onclick="closeQuoteModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="quote-form" class="space-y-6">
                    <!-- 헤더 섹션 (로고/제목/회사정보 + 인자 테이블) -->
                    <div>
                        <!-- 상단: 로고 + 제목 중앙 정렬 -->
                        <div class="flex items-center justify-center gap-4">
                            <img id="quote-logo" src="assets/quote/logo.png" alt="청우환경 로고" class="h-16 w-auto" onerror="this.src='청우환경 로고.png';">
                            <h1 class="text-5xl font-extrabold tracking-wider">견적서</h1>
                        </div>
                        
                        <!-- 본문 상단 2열: 좌측 인자표, 우측 회사정보 박스 -->
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-[520px_1fr] gap-6 items-start">
                            <!-- 좌측: 수신/견적정보 표 -->
                            <div class="w-[500px]">
                                <table class="quote-table text-sm">
                                    <tbody>
                                        <tr>
                                            <th class="w-24 bg-gray-50 border border-gray-300 px-3 py-2 text-gray-700 text-left">수 신</th>
                                            <td class="border border-gray-300 px-3 py-2"><input type="text" id="recipient" class="w-full px-2 py-1 border-0 focus:outline-none" value="청명기연환경 귀하" aria-label="수신"></td>
                                            <th class="w-24 bg-gray-50 border border-gray-300 px-3 py-2 text-gray-700 text-left">견적No.</th>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <div class="flex items-center gap-2">
                                                    <input type="text" id="quote-number" class="flex-1 px-2 py-1 border-0 focus:outline-none" placeholder="견적번호" aria-label="견적번호">
                                                    <button type="button" id="purchase-request-import-toggle" onclick="togglePurchaseRequestImport()" class="px-2 py-1 text-xs bg-blue-100 text-blue-700 border border-blue-200 rounded hover:bg-blue-200 transition-colors" title="구매요구서 불러오기">
                                                        📋
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="bg-gray-50 border border-gray-300 px-3 py-2 text-gray-700 text-left">견적날짜</th>
                                            <td class="border border-gray-300 px-3 py-2"><input type="date" id="quote-date" class="w-full px-2 py-1 border-0 focus:outline-none" aria-label="견적날짜"></td>
                                            <th class="bg-gray-50 border border-gray-300 px-3 py-2 text-gray-700 text-left">일자</th>
                                            <td class="border border-gray-300 px-3 py-2 text-gray-500">&nbsp;</td>
                                        </tr>
                                        <tr>
                                            <th class="bg-gray-50 border border-gray-300 px-3 py-2 text-gray-700 text-left">유효기간</th>
                                            <td class="border border-gray-300 px-3 py-2"><input type="text" id="validity-period" class="w-full px-2 py-1 border-0 focus:outline-none" value="견적일로부터 30일" aria-label="유효기간"></td>
                                            <th class="bg-gray-50 border border-gray-300 px-3 py-2 text-gray-700 text-left">납품기간</th>
                                            <td class="border border-gray-300 px-3 py-2"><input type="text" id="delivery-period" class="w-full px-2 py-1 border-0 focus:outline-none" value="발주일로부터 30일" aria-label="납품기간"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- 우측: 회사 정보 박스 + 직인 (인자표와 같은 수평선상) -->
                            <div class="relative w-[420px] border border-gray-300 rounded-md p-4 md:mt-[6px]">
                                <div class="text-sm text-gray-700 leading-6">
                                    <p><strong>사업자등록번호:</strong> 323-81-01027</p>
                                    <p><strong>주소:</strong> 서울시 송파구 백제고분로 36길 12, 1층</p>
                                    <p><strong>대표:</strong> 심 애 경</p>
                                    <p><strong>업태:</strong> 도소매 &nbsp; <strong>업종:</strong> 과학기기, 이화학기기, 소모품</p>
                                    <p><strong>전화:</strong> 02-6952-7880 &nbsp; <strong>팩스:</strong> 02-420-2175</p>
                                    <p><strong>메일:</strong> cwenv.sales@gmail.com</p>
                                </div>
                                <img id="quote-seal" src="assets/quote/seal.png" alt="직인" class="absolute top-2 right-2 h-16 w-16 opacity-90" onerror="this.src='직인.png';">
                            </div>
                        </div>
                    </div>

                    <!-- 견적금액 요약 (양식 상단 띠) -->
                    <div class="mt-4">
                        <table class="quote-table text-sm">
                            <tbody>
                                <tr>
                                    <th class="w-40 bg-gray-50 border border-gray-300 px-3 py-2 text-left">견 적 금 액 :</th>
                                    <td class="w-20 border border-gray-300 px-3 py-2">일금</td>
                                    <td class="border border-gray-300 px-3 py-2">
                                        <input id="total-amount-korean" class="w-full px-2 py-1 border-0 focus:outline-none" value="영" aria-label="일금(한글)">
                                    </td>
                                    <td class="w-80 border border-gray-300 px-3 py-2 text-right">
                                        <input id="total-amount-numeric" class="text-right w-40 px-2 py-1 border border-gray-200 rounded" value="( 0 )" aria-label="합계(숫자)">
                                        <span class="ml-2 text-gray-600">※ 부가세포함</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 품목 리스트 테이블 (양식 본문) -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">품목 리스트</label>
                        <div class="overflow-x-auto">
                            <table class="quote-table text-sm">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 6%;">No.</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 18%;">제품번호</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 34%;">세 부 내 용</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 8%;">수량</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 12%;">단가</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 12%;">금액</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 10%;">납기</th>
                                        <th class="border border-gray-300 px-3 py-2 text-center" style="width: 8%;">작업</th>
                                    </tr>
                                </thead>
                                <tbody id="quote-items-table-body">
                                    <tr class="quote-item-row">
                                        <td class="border border-gray-300 px-3 py-2 text-center">1</td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="제품번호">
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="세부내용">
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="number" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="수량" min="1">
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="number" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="단가" min="0">
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" readonly>
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="납기">
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2 text-center">
                                            <button type="button" onclick="removeQuoteItemRow(this)" class="text-red-600 hover:text-red-800 px-2 py-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <button type="button" onclick="addQuoteItemRow()" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                                + 품목 추가
                            </button>
                        </div>
                    </div>

                    <!-- 합계 섹션 (표 하단 공급가/부가세/합계) -->
                    <div class="flex justify-end mt-4">
                        <div class="w-80">
                            <table class="quote-table text-sm">
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 px-3 py-2 bg-gray-50 font-medium">공급가액</td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" id="supply-amount" class="w-full px-2 py-1 border-0 focus:outline-none bg-transparent" readonly value="0원" data-value="0">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-3 py-2 bg-gray-50 font-medium">부 가 세</td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" id="quote-vat" class="w-full px-2 py-1 border-0 focus:outline-none bg-transparent" readonly value="0원" data-value="0">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-3 py-2 bg-gray-50 font-medium">합계금액</td>
                                        <td class="border border-gray-300 px-3 py-2">
                                            <input type="text" id="quote-total-amount" class="w-full px-2 py-1 border-0 focus:outline-none bg-transparent" readonly value="0원" data-value="0">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 비고 및 은행 정보 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 비고 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">비고</label>
                            <textarea id="remarks" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="추가 정보를 입력하세요"></textarea>
                        </div>
                        
                        <!-- 은행 정보 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">결제 정보</label>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-700 space-y-2">
                                    <p class="font-medium">기업은행: 132-106361-04-016, 예금주: (주)청우환경</p>
                                    <p class="text-xs text-gray-500 mt-2">비고</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 버튼 -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="printQuote()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 no-print">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2v4a2 2 0 002 2h6a2 2 0 002-2z"></path>
                            </svg>
                            인쇄
                        </button>
                        <button type="button" onclick="closeQuoteModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                            취소
                        </button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            저장
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="scripts/fetch_data.js"></script>
    
    <script>
        // file:// 환경 금지 및 공통 fetch 유틸 (cache: no-store) + 상태 라벨 표준화
        function assertHttpProtocol() {
            if (location.protocol === 'file:') {
                document.body.innerHTML = '<div style="text-align:center;color:#111;padding:50px;"><h2>로컬 파일로는 실행할 수 없습니다.</h2><p>터미널에서 <code>npx http-server -c-1 .</code>로 로컬 서버를 띄워 접속해주세요.</p></div>';
                throw new Error('file protocol is not allowed for this app');
            }
        }
        function safeFetch(resource, init) {
            assertHttpProtocol();
            const nextInit = Object.assign({ cache: 'no-store' }, init || {});
            const headers = new Headers((init && init.headers) || {});
            headers.set('Cache-Control', 'no-store');
            nextInit.headers = headers;
            return fetch(resource, nextInit);
        }
        // EUC-KR/CP949 한글 CSV 대응: 바이너리 후 최적 디코딩 선택
        async function fetchKoreanText(resource) {
            const res = await safeFetch(resource);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const buf = await res.arrayBuffer();
            function score(s) {
                if (!s) return -1e9;
                const hangul = (s.match(/[가-힣]/g) || []).length;
                const repl = (s.match(/�/g) || []).length;
                return hangul * 5 - repl * 10;
            }
            let best = '';
            let bestScore = -1e9;
            try { const s = new TextDecoder('utf-8').decode(buf); const sc = score(s); if (sc > bestScore) { best = s; bestScore = sc; } } catch {}
            try { const s = new TextDecoder('euc-kr').decode(buf); const sc = score(s); if (sc > bestScore) { best = s; bestScore = sc; } } catch {}
            // 일부 브라우저는 cp949를 지원하지 않음 → euc-kr로 충분한 경우가 많음
            return best || new TextDecoder('utf-8').decode(buf);
        }
        function normalizeStatus(raw) {
            const s = String(raw || '').trim();
            if (/업체/.test(s)) return '수리 중';
            if (/현장/.test(s)) return '가동 중';
            if (/청명|본사/.test(s)) return '대기 중';
            const t = s.toLowerCase();
            if (t === '수리중' || t === '수리 중' || /repair|정비|maintenance|fix/.test(t)) return '수리 중';
            if (t === '가동중' || t === '가동 중' || /run|running/.test(t)) return '가동 중';
            if (t === '대기중' || t === '대기 중' || /idle|standby|미사용|보관|비가동/.test(t)) return '대기 중';
            return '대기 중';
        }
        // 대시보드 데이터 로드 및 표시
        async function loadDashboardData() {
            try {
                console.log('대시보드 데이터 로드 시작...');
                const response = await safeFetch('db/dashboard_data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('대시보드 데이터 로드 성공:', data);
                updateDashboard(data);
                await loadRepairVisibilityStats();
                await loadRepairLogTable();
                await buildRepairCategoryGrid();
            } catch (error) {
                console.error('대시보드 데이터 로드 오류:', error);
                console.log('기본 데이터 로드로 전환...');
                // 대시보드 데이터가 없으면 기본 데이터로 표시
                loadDefaultDashboardData();
            }
        }
        
        // 기본 대시보드 데이터 로드 (DB 파일이 없는 경우)
        async function loadDefaultDashboardData() {
            try {
                // 장비 데이터 로드
                const equipmentResponse = await safeFetch('db/equipment_db_clean.json');
                const equipmentData = await equipmentResponse.json();
                
                // 수리 데이터 로드
                const repairsResponse = await safeFetch('db/repairs_db_clean.json');
                const repairsData = await repairsResponse.json();
                
                // 통합 데이터 생성
                const dashboardData = {
                    equipment_summary: {
                        total_equipment: equipmentData.length,
                        by_measurement_item: {}
                    },
                    repairs_summary: {
                        total_repairs: repairsData.length,
                        equipment_match_rate: 0,
                        cost_summary: { total_cost: 0 }
                    },
                    top_equipment: { most_repaired: [] },
                    recent_activity: { last_repairs: [] }
                };
                
                // 측정항목별 통계
                equipmentData.forEach(equipment => {
                    const item = equipment.measurement_item || '알 수 없음';
                    dashboardData.equipment_summary.by_measurement_item[item] = 
                        (dashboardData.equipment_summary.by_measurement_item[item] || 0) + 1;
                });
                
                // 수리 통계
                if (repairsData.length > 0) {
                    const matchedCount = repairsData.filter(repair => 
                        repair.measurement_item && repair.measurement_item !== '알 수 없음'
                    ).length;
                    dashboardData.repairs_summary.equipment_match_rate = 
                        Math.round((matchedCount / repairsData.length) * 100 * 10) / 10;
                    
                    // 비용 계산
                    repairsData.forEach(repair => {
                        try {
                            const cost = parseInt(repair.cost?.replace(/,/g, '') || '0');
                            dashboardData.repairs_summary.cost_summary.total_cost += cost;
                        } catch (e) {
                            // 비용 파싱 오류 무시
                        }
                    });
                    
                    // 수리 횟수 상위 장비
                    const serialCounts = {};
                    repairsData.forEach(repair => {
                        const serial = repair.serial;
                        if (serial) {
                            serialCounts[serial] = (serialCounts[serial] || 0) + 1;
                        }
                    });
                    
                    dashboardData.top_equipment.most_repaired = Object.entries(serialCounts)
                        .map(([serial, count]) => ({ serial, repair_count: count }))
                        .sort((a, b) => b.repair_count - a.repair_count)
                        .slice(0, 10);
                    
                    // 최근 수리 기록
                    dashboardData.recent_activity.last_repairs = repairsData.slice(-5);
                }
                
                updateDashboard(dashboardData);
                await loadRepairVisibilityStats();
                await loadRepairLogTable();
                await buildRepairCategoryGrid();
                
            } catch (error) {
                console.error('기본 데이터 로드 오류:', error);
                showDashboardError();
            }
        }

        // 수리 가시성 통계 로드 및 렌더링 (db/stats_*.json 사용)
        async function loadRepairVisibilityStats() {
            try {
                const [m1, m2, t1] = await Promise.all([
                    safeFetch('db/stats_repairs_monthly.json'),
                    safeFetch('db/stats_repair_cost_monthly.json'),
                    safeFetch('db/stats_repairs_topk.json')
                ]);
                let monthly = [];
                if (m1.ok) { const j = await m1.json(); monthly = j.data || []; }
                if ((!monthly || !monthly.length) && m2.ok) { const j2 = await m2.json(); monthly = j2.data || []; }
                let topk = {};
                if (t1.ok) { const jt = await t1.json(); topk = jt.data || {}; }

                // 최종 폴백: repairs_db_clean에서 즉석 월별 집계/TopK
                if ((!monthly || !monthly.length) || !topk.topCompaniesByCost) {
                    try {
                        const r = await safeFetch('db/repairs_db_clean.json');
                        if (r.ok) {
                            const rows = await r.json();
                            if (!monthly || !monthly.length) {
                                const map = new Map();
                                rows.forEach(x => { const ym = (x.repair_date||x.date||'').slice(0,7); if (!ym) return; const c = map.get(ym)||{count:0,totalCost:0}; c.count++; c.totalCost += (x.cost||0); map.set(ym,c); });
                                monthly = Array.from(map.entries()).map(([month,v])=>({month, count:v.count, totalCost:v.totalCost})).sort((a,b)=> a.month.localeCompare(b.month));
                            }
                            if (!topk.topCompaniesByCost) {
                                const comp = new Map();
                                rows.forEach(x=>{ const k=x.repair_company||x.company||'알 수 없음'; const v=comp.get(k)||{company:k,count:0,totalCost:0}; v.count++; v.totalCost+=(x.cost||0); comp.set(k,v); });
                                topk.topCompaniesByCost = Array.from(comp.values()).sort((a,b)=> b.totalCost-a.totalCost).slice(0,10);
                            }
                            if (!topk.topCategoriesByCost) {
                                const cat = await (await safeFetch('db/stats_repairs_by_category.json')).json().catch(()=>({data:[]}));
                                topk.topCategoriesByCost = (cat.data||[]).slice(0,10);
                            }
                            if (!topk.topSerialsByCost) {
                                const ser = await (await safeFetch('db/stats_repairs_by_serial.json')).json().catch(()=>({data:[]}));
                                topk.topSerialsByCost = (ser.data||[]).slice(0,10);
                            }
                        }
                    } catch {}
                }

                renderRepairsMonthlyChart(monthly || []);
                renderTopCompaniesChart(topk.topCompaniesByCost || []);
                renderTopCategoriesTable(topk.topCategoriesByCost || []);
                renderTopSerialsTable(topk.topSerialsByCost || []);
            } catch (e) {
                console.warn('수리 가시성 통계 로드 실패:', e);
            }
        }

        function renderRepairsMonthlyChart(rows) {
            const canvas = document.getElementById('repairsMonthlyChart');
            if (!canvas) return;
            const parent = canvas.parentElement;
            const table = document.createElement('table');
            table.className = 'w-full text-sm';
            const thead = document.createElement('thead');
            thead.className = 'bg-slate-100';
            thead.innerHTML = '<tr><th class="text-left p-2">월</th><th class="text-left p-2">건수</th><th class="text-left p-2">총비용</th></tr>';
            const tbody = document.createElement('tbody');
            const data = (rows||[]).slice(-12);
            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class=\"p-2\">${r.month}</td><td class=\"p-2\">${(r.count||0).toLocaleString()}건</td><td class=\"p-2\">${(r.totalCost||0).toLocaleString()}원</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(thead); table.appendChild(tbody);
            parent.replaceChild(table, canvas);
        }

        function renderTopCompaniesChart(items) {
            const canvas = document.getElementById('topCompaniesByCostChart');
            if (!canvas) return;
            const parent = canvas.parentElement;
            const container = document.createElement('div');
            container.className = 'space-y-2';
            const top = (items||[]).slice(0,10);
            const max = Math.max(1, ...top.map(i=>i.totalCost||0));
            top.forEach(i => {
                const row = document.createElement('div');
                row.className = 'w-full';
                const pct = Math.round(((i.totalCost||0)/max)*100);
                row.innerHTML = `
                    <div class=\"flex justify-between text-sm\">
                        <span class=\"font-medium text-slate-800\">${i.company}</span>
                        <span class=\"text-slate-600\">${(i.totalCost||0).toLocaleString()}원</span>
                    </div>
                    <div class=\"h-2 bg-slate-200 rounded\">
                        <div class=\"h-2 bg-emerald-500 rounded\" style=\"width:${pct}%\"></div>
                    </div>
                `;
                container.appendChild(row);
            });
            parent.replaceChild(container, canvas);
        }

        function renderTopCategoriesTable(items) {
            const tbody = document.getElementById('topCategoriesBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            items.slice(0, 15).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${row.category}</td>
                    <td class="p-2">${(row.count||0).toLocaleString()}건</td>
                    <td class="p-2">${(row.totalCost||0).toLocaleString()}원</td>
                    <td class="p-2">${(row.avgCost||0).toLocaleString()}원</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTopSerialsTable(items) {
            const tbody = document.getElementById('topSerialsBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            items.slice(0, 15).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 font-medium">${row.serial}</td>
                    <td class="p-2">${row.category||'-'}</td>
                    <td class="p-2">${(row.count||0).toLocaleString()}건</td>
                    <td class="p-2">${(row.totalCost||0).toLocaleString()}원</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== 수리 로그 로딩/필터/드래그 스크롤 =====
        let __repairLogAllRows = [];
        async function loadRepairLogTable() {
            try {
                const res = await safeFetch('db/repairs_db_clean.json');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const rows = await res.json();
                __repairLogAllRows = rows.map(r => ({
                    date: (r.repair_date || r.date || '').slice(0,10),
                    serial: r.serial || '',
                    category: r.equipment_category || r.product_series || r.category || '알 수 없음',
                    company: r.repair_company || r.company || '알 수 없음',
                    manager: r.manager || '',
                    type: r.repair_type || r.type || '',
                    measurement: r.measurement_item || '',
                    cost: typeof r.cost === 'number' ? r.cost : parseInt(String(r.cost||'').replace(/[^0-9]/g,'')) || 0,
                    note: r.details || r.note || ''
                }));
                buildRepairCategoryFilter(__repairLogAllRows);
                renderRepairLogTable();
                enableDragScroll('repair-log-scroll');
            } catch (e) {
                console.warn('수리 로그 로드 실패:', e);
                const tbody = document.getElementById('repair-log-tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">수리 데이터가 없습니다</td></tr>';
            }
        }

        function buildRepairCategoryFilter(rows) {
            const sel = document.getElementById('repair-category-filter');
            if (!sel) return;
            const cats = Array.from(new Set(rows.map(r => r.category))).filter(Boolean).sort();
            sel.innerHTML = '<option value="all">전체 품목계열</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            sel.onchange = renderRepairLogTable;
            const q = document.getElementById('repair-search-input');
            if (q) { q.oninput = debounce(renderRepairLogTable, 150); }
        }

        function renderRepairLogTable() {
            const tbody = document.getElementById('repair-log-tbody');
            if (!tbody) return;
            const cat = (document.getElementById('repair-category-filter')?.value) || 'all';
            const q = (document.getElementById('repair-search-input')?.value || '').toLowerCase();
            const rows = __repairLogAllRows.filter(r => (cat === 'all' || r.category === cat))
                .filter(r => !q || [r.serial, r.company, r.type, r.manager, r.note, r.category, r.measurement]
                    .some(v => String(v||'').toLowerCase().includes(q)));
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">일치하는 기록이 없습니다</td></tr>';
                return;
            }
            const frag = document.createDocumentFragment();
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 whitespace-nowrap">${r.date}</td>
                    <td class="p-2 whitespace-nowrap font-medium">${r.serial}</td>
                    <td class="p-2">${r.category}</td>
                    <td class="p-2">${r.company}</td>
                    <td class="p-2">${r.manager}</td>
                    <td class="p-2">${r.type}</td>
                    <td class="p-2">${r.measurement}</td>
                    <td class="p-2 text-right">${r.cost.toLocaleString()}원</td>
                    <td class="p-2">${r.note}</td>
                `;
                frag.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(frag);
        }

        function enableDragScroll(containerId) {
            const el = document.getElementById(containerId);
            if (!el) return;
            let isDown = false, startX = 0, scrollLeft = 0;
            el.addEventListener('mousedown', (e) => {
                isDown = true;
                el.classList.add('cursor-grabbing');
                startX = e.pageX - el.offsetLeft;
                scrollLeft = el.scrollLeft;
            });
            el.addEventListener('mouseleave', () => { isDown = false; el.classList.remove('cursor-grabbing'); });
            el.addEventListener('mouseup', () => { isDown = false; el.classList.remove('cursor-grabbing'); });
            el.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - el.offsetLeft;
                const walk = (x - startX) * 1; // 속도
                el.scrollLeft = scrollLeft - walk;
            });
        }

        function debounce(fn, ms) {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), ms); };
        }

        // ===== 품목계열 대분류 그리드/상세 =====
        async function buildRepairCategoryGrid() {
            try {
                // serials.csv의 3열(품목계열)로만 분류
                let serialsText = '';
                try { serialsText = await fetchKoreanText('청명장비 엑셀/serials.csv'); } catch {}
                if (!serialsText) {
                    // 경로 이슈 대비
                    try { serialsText = await fetchKoreanText('serials.csv'); } catch {}
                }
                const categories = new Set();
                const measurementToSeries = new Map(); // 측정항목 -> Set(품목계열)
                if (serialsText) {
                    const lines = serialsText.split(/\r?\n/).slice(1); // 헤더 제외
                    lines.forEach(line => {
                        const parts = line.split(',');
                        if (parts.length >= 3) {
                            const cat = (parts[1] || '').trim();
                            // (측정항목) 품목계열 파싱
                            const m = cat.match(/^\(([^)]+)\)\s*(.+)$/);
                            const measurement = m ? m[1].trim() : '알 수 없음';
                            const series = m ? m[2].trim() : cat;
                            if (cat) categories.add(cat);
                            if (!measurementToSeries.has(measurement)) measurementToSeries.set(measurement, new Set());
                            measurementToSeries.get(measurement).add(cat);
                        }
                    });
                }
                // repairs 데이터로 건수/총비용 채우기
                const catsMap = new Map(Array.from(categories).map(c => [c, { category: c, count: 0, totalCost: 0 }]));
                (__repairLogAllRows||[]).forEach(r => {
                    const cat = r.category || '';
                    if (catsMap.has(cat)) {
                        const v = catsMap.get(cat);
                        v.count += 1;
                        v.totalCost += r.cost || 0;
                    }
                });
                // 좌측 측정항목 토글 렌더
                const measList = document.getElementById('measurement-list');
                const seriesGrid = document.getElementById('product-series-grid');
                if (!measList || !seriesGrid) return;
                measList.innerHTML = '';
                seriesGrid.innerHTML = '';
                const measurements = Array.from(measurementToSeries.keys()).sort();
                let currentMeasurement = measurements[0] || '';
                function renderSeries(measurement){
                    currentMeasurement = measurement;
                    seriesGrid.innerHTML = '';
                    const seriesSet = measurementToSeries.get(measurement) || new Set();
                    const list = Array.from(seriesSet).map(cat => catsMap.get(cat) || {category:cat,count:0,totalCost:0});
                    list.sort((a,b)=> b.totalCost - a.totalCost);
                    list.forEach(c => {
                        const btn = document.createElement('button');
                        btn.className = 'text-left p-4 rounded border hover:border-indigo-400 hover:shadow transition';
                        btn.innerHTML = `
                            <div class=\"text-sm text-slate-500\">품목계열</div>
                            <div class=\"font-semibold text-slate-800 truncate\" title=\"${c.category}\">${c.category}</div>
                            <div class=\"mt-2 text-xs text-slate-500\">건수</div>
                            <div class=\"text-slate-700\">${c.count.toLocaleString()}건</div>
                            <div class=\"mt-1 text-xs text-slate-500\">총비용</div>
                            <div class=\"text-emerald-600 font-medium\">${c.totalCost.toLocaleString()}원</div>
                        `;
                        btn.onclick = () => showRepairCategoryDetail(c.category);
                        seriesGrid.appendChild(btn);
                    });
                }
                measurements.forEach(m => {
                    const t = document.createElement('button');
                    t.className = 'px-3 py-2 rounded border text-sm text-slate-700 hover:border-indigo-400 text-left';
                    t.textContent = m;
                    t.onclick = () => renderSeries(m);
                    measList.appendChild(t);
                });
                renderSeries(currentMeasurement);
            } catch (e) {
                console.warn('카테고리 그리드 생성 실패:', e);
            }
        }

        async function showRepairCategoryDetail(category) {
            const title = document.getElementById('repair-category-title');
            const stats = document.getElementById('repair-category-stats');
            const ul = document.getElementById('repair-category-companies');
            const tbody = document.getElementById('repair-category-serials-tbody');
            if (!title || !stats || !ul || !tbody) return;
            title.textContent = `카테고리 상세 - ${category}`;

            try {
                const [catRes, serRes] = await Promise.all([
                    safeFetch('db/stats_repairs_by_category.json'),
                    safeFetch('db/stats_repairs_by_serial.json')
                ]);
                const catData = catRes.ok ? (await catRes.json()).data || [] : [];
                const serData = serRes.ok ? (await serRes.json()).data || [] : [];
                const c = catData.find(x => x.category === category);
                // 상단 KPI
                stats.innerHTML = '';
                const kpis = [
                    { k: '건수', v: (c?.count||0).toLocaleString() },
                    { k: '총비용', v: (c?.totalCost||0).toLocaleString() + '원' },
                    { k: '평균', v: (c?.avgCost||0).toLocaleString() + '원' },
                    { k: '최소', v: (c?.minCost??0).toLocaleString() + '원' },
                    { k: '최대', v: (c?.maxCost??0).toLocaleString() + '원' },
                ];
                kpis.forEach(x => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-slate-50 rounded border';
                    div.innerHTML = `<div class="text-xs text-slate-500">${x.k}</div><div class="text-base font-semibold text-slate-800">${x.v}</div>`;
                    stats.appendChild(div);
                });
                // 업체 분포
                ul.innerHTML = '';
                (c?.companies||[]).forEach(it => {
                    const li = document.createElement('li');
                    li.textContent = `${it.company} - ${it.count}건`;
                    ul.appendChild(li);
                });
                if (!c?.companies?.length) ul.innerHTML = '<li class="text-slate-500">업체 정보 없음</li>';
                // 월별 미니차트 및 시리얼 목록(정렬/필터)
                try {
                    const raw = __repairLogAllRows?.length ? __repairLogAllRows : [];
                    const byMonth = new Map();
                    raw.filter(r => r.category === category).forEach(r => {
                        const ym = (r.date||'').slice(0,7);
                        if (!ym) return;
                        const prev = byMonth.get(ym) || { count: 0, cost: 0 };
                        prev.count += 1; prev.cost += r.cost||0;
                        byMonth.set(ym, prev);
                    });
                    const labels = Array.from(byMonth.keys()).sort();
                    const counts = labels.map(k => byMonth.get(k).count);
                    const costs = labels.map(k => byMonth.get(k).cost);
                    const canv = document.getElementById('categoryMonthlyMiniChart');
                    if (canv && window.Chart) {
                        if (window.categoryMonthlyMiniChart && window.categoryMonthlyMiniChart.destroy) window.categoryMonthlyMiniChart.destroy();
                        window.categoryMonthlyMiniChart = new Chart(canv.getContext('2d'), {
                            type: 'bar',
                            data: { labels, datasets: [
                                { label: '건수', data: counts, backgroundColor: '#3B82F6', yAxisID: 'y' },
                                { label: '총비용(원)', data: costs, backgroundColor: '#F59E0B', yAxisID: 'y1' },
                            ]},
                            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } } }, plugins: { legend: { display: false } } }
                        });
                    }
                } catch {}
                // 정렬/필터 구성
                const compSel = document.getElementById('category-company-filter');
                const typeSel = document.getElementById('category-type-filter');
                const sortSel = document.getElementById('category-serials-sort');
                const setBySerialCompany = new Map();
                const setBySerialType = new Map();
                (__repairLogAllRows||[]).filter(r => r.category === category).forEach(r => {
                    const s = r.serial; if (!s) return;
                    if (r.company) setBySerialCompany.set(s, (setBySerialCompany.get(s)||new Set()).add(r.company));
                    if (r.type) setBySerialType.set(s, (setBySerialType.get(s)||new Set()).add(r.type));
                });
                function applySerialFilters() {
                    let arr = serData.filter(x => x.category === category);
                    const comp = compSel?.value||'all';
                    const typ = typeSel?.value||'all';
                    if (comp !== 'all') arr = arr.filter(x => (setBySerialCompany.get(x.serial)||new Set()).has(comp));
                    if (typ !== 'all') arr = arr.filter(x => (setBySerialType.get(x.serial)||new Set()).has(typ));
                    const srt = sortSel?.value||'cost_desc';
                    arr.sort((a,b)=>{
                        switch(srt){
                            case 'cost_asc': return (a.totalCost||0)-(b.totalCost||0);
                            case 'count_desc': return (b.count||0)-(a.count||0);
                            case 'count_asc': return (a.count||0)-(b.count||0);
                            case 'last_desc': return String(b.lastRepairDate||'').localeCompare(String(a.lastRepairDate||''));
                            case 'last_asc': return String(a.lastRepairDate||'').localeCompare(String(b.lastRepairDate||''));
                            default: return (b.totalCost||0)-(a.totalCost||0);
                        }
                    });
                    return arr.slice(0, 500);
                }
                function renderSerials(arr){
                    const frag = document.createDocumentFragment();
                    arr.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-2 font-medium">${s.serial}</td>
                            <td class="p-2">${(s.count||0).toLocaleString()}</td>
                            <td class="p-2">${(s.totalCost||0).toLocaleString()}원</td>
                            <td class="p-2">${s.firstRepairDate||''}</td>
                            <td class="p-2">${s.lastRepairDate||''}</td>
                        `;
                        tr.onclick = () => focusRepairLogBySerial(s.serial);
                        frag.appendChild(tr);
                    });
                    tbody.innerHTML = '';
                    tbody.appendChild(frag);
                }
                if (compSel) {
                    const comps = Array.from(new Set((__repairLogAllRows||[]).filter(r=>r.category===category).map(r=>r.company).filter(Boolean))).sort();
                    compSel.innerHTML = '<option value="all">전체 업체</option>' + comps.map(c=>`<option value="${c}">${c}</option>`).join('');
                    compSel.onchange = ()=> renderSerials(applySerialFilters());
                }
                if (typeSel) {
                    const types = Array.from(new Set((__repairLogAllRows||[]).filter(r=>r.category===category).map(r=>r.type).filter(Boolean))).sort();
                    typeSel.innerHTML = '<option value="all">전체 유형</option>' + types.map(c=>`<option value="${c}">${c}</option>`).join('');
                    typeSel.onchange = ()=> renderSerials(applySerialFilters());
                }
                if (sortSel) sortSel.onchange = ()=> renderSerials(applySerialFilters());
                renderSerials(applySerialFilters());
                const expBtn = document.getElementById('category-export-btn');
                if (expBtn) expBtn.onclick = () => exportSerialsCSV(applySerialFilters(), category);
            } catch (e) {
                console.warn('카테고리 상세 로드 실패:', e);
            }
        }

        function focusRepairLogBySerial(serial) {
            // 상단 검색창에 주입 후 테이블 렌더
            const q = document.getElementById('repair-search-input');
            if (q) { q.value = serial; }
            renderRepairLogTable();
            // 수리 로그 섹션으로 스크롤
            document.getElementById('repair-log-scroll')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 전체 수리 로그: 상태/정렬/페이지네이션/CSV
        let __repairPage = 1, __repairPageSize = 100, __repairFilteredRows = [];
        function currentRepairFilters() {
            const cat = (document.getElementById('repair-category-filter')?.value)||'all';
            const q = (document.getElementById('repair-search-input')?.value||'').toLowerCase();
            const comp = (document.getElementById('repair-company-filter')?.value)||'all';
            const typ = (document.getElementById('repair-type-filter')?.value)||'all';
            const sort = (document.getElementById('repair-sort-select')?.value)||'date_desc';
            return { cat, q, comp, typ, sort };
        }
        function applyRepairFilters() {
            const {cat,q,comp,typ,sort} = currentRepairFilters();
            let rows = __repairLogAllRows.slice();
            if (cat !== 'all') rows = rows.filter(r=>r.category===cat);
            if (comp !== 'all') rows = rows.filter(r=>r.company===comp);
            if (typ !== 'all') rows = rows.filter(r=>r.type===typ);
            if (q) rows = rows.filter(r=> [r.serial,r.company,r.type,r.manager,r.note,r.category,r.measurement].some(v=>String(v||'').toLowerCase().includes(q)) );
            switch (sort) {
                case 'date_asc': rows.sort((a,b)=> String(a.date||'').localeCompare(String(b.date||''))); break;
                case 'cost_desc': rows.sort((a,b)=> (b.cost||0)-(a.cost||0)); break;
                case 'cost_asc': rows.sort((a,b)=> (a.cost||0)-(b.cost||0)); break;
                default: rows.sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
            }
            __repairFilteredRows = rows;
        }
        function renderRepairLogTable() {
            const tbody = document.getElementById('repair-log-tbody');
            if (!tbody) return;
            if (!__repairLogAllRows.length) { tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">수리 데이터가 없습니다</td></tr>'; return; }
            applyRepairFilters();
            const pageSizeSel = document.getElementById('repair-page-size');
            __repairPageSize = parseInt(pageSizeSel?.value||'100',10)||100;
            const total = __repairFilteredRows.length;
            const totalPages = Math.max(1, Math.ceil(total/__repairPageSize));
            if (__repairPage>totalPages) __repairPage=totalPages;
            const start = (__repairPage-1)*__repairPageSize;
            const end = Math.min(total, start+__repairPageSize);
            const slice = __repairFilteredRows.slice(start,end);
            const frag = document.createDocumentFragment();
            slice.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 whitespace-nowrap">${r.date}</td>
                    <td class="p-2 whitespace-nowrap font-medium">${r.serial}</td>
                    <td class="p-2">${r.category}</td>
                    <td class="p-2">${r.company}</td>
                    <td class="p-2">${r.manager}</td>
                    <td class="p-2">${r.type}</td>
                    <td class="p-2">${r.measurement}</td>
                    <td class="p-2 text-right">${r.cost.toLocaleString()}원</td>
                    <td class="p-2">${r.note}</td>
                `;
                frag.appendChild(tr);
            });
            tbody.innerHTML = '';
            tbody.appendChild(frag);
            const info = document.getElementById('repair-page-info');
            if (info) info.textContent = `${__repairPage} / ${totalPages} (총 ${total.toLocaleString()}건)`;
        }
        (function bindRepairControls(){
            const els = ['repair-category-filter','repair-search-input','repair-company-filter','repair-type-filter','repair-sort-select','repair-page-size'];
            els.forEach(id => { const el = document.getElementById(id); if (!el) return; const h = id==='repair-search-input'?debounce(renderRepairLogTable,150):renderRepairLogTable; el.addEventListener('input',h); el.addEventListener('change',h); });
            const prev = document.getElementById('repair-prev-page');
            const next = document.getElementById('repair-next-page');
            if (prev) prev.onclick = ()=>{ if (__repairPage>1){ __repairPage--; renderRepairLogTable(); } };
            if (next) next.onclick = ()=>{ const totalPages = Math.max(1, Math.ceil((__repairFilteredRows.length||0)/__repairPageSize)); if (__repairPage<totalPages){ __repairPage++; renderRepairLogTable(); } };
            const exportBtn = document.getElementById('repair-log-export-btn');
            if (exportBtn) exportBtn.onclick = ()=> exportRepairsCSV(__repairFilteredRows);
        })();
        function exportSerialsCSV(arr, category){
            const headers = ['serial','category','count','totalCost','firstRepairDate','lastRepairDate'];
            const lines = [headers.join(',')].concat(arr.map(s => headers.map(h => JSON.stringify(String(s[h]??'').replace(/\"/g,'"'))).join(',')));
            downloadCSV(lines.join('\n'), `serials_${category}.csv`);
        }
        function exportRepairsCSV(rows){
            const headers = ['date','serial','category','company','manager','type','measurement','cost','note'];
            const lines = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(String(r[h]??'').replace(/\"/g,'"'))).join(',')));
            downloadCSV(lines.join('\n'), 'repairs.csv');
        }
        function downloadCSV(content, filename){
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }
        
        // 대시보드 업데이트
        async function updateDashboard(data) {
            try {
                console.log('대시보드 업데이트 시작:', data);
                
            // 통계 카드 업데이트
                if (data.equipment_summary) {
            document.getElementById('total-equipment').textContent = data.equipment_summary.total_equipment + ' 대';
            document.getElementById('total-repairs').textContent = data.repairs_summary.total_repairs + ' 건';
            document.getElementById('match-rate').textContent = data.repairs_summary.equipment_match_rate + '%';
            document.getElementById('total-cost').textContent = data.repairs_summary.cost_summary.total_cost.toLocaleString() + '원';
                }
            
            // 차트 생성 (품목계열별 가동률 차트는 별도 데이터 로드)
            createEquipmentChart();
                await createRepairsChart(data.repairs_summary?.by_company || {});
                
                // 새로운 테이블 업데이트
                updateNextWeekUptimeTable();
                updateRecentRepairsTable(data.recent_activity?.last_repairs || []);
                updateAlertsTable();
                
                // 마지막 업데이트 시간
                const lastUpdatedElement = document.getElementById('last-updated');
                if (lastUpdatedElement) {
                    lastUpdatedElement.textContent = new Date().toLocaleString('ko-KR');
                }
                
                console.log('대시보드 업데이트 완료');
                
            } catch (error) {
                console.error('대시보드 업데이트 오류:', error);
                // 오류 발생 시 기본 데이터로 대시보드 구성
                loadDefaultDashboardData();
            }
        }
        
        // 기본 대시보드 데이터 로드 (오류 시 사용)
        async function loadDefaultDashboardData() {
            try {
                console.log('기본 대시보드 데이터 로드 시작...');
                
                // 실제 데이터로 통계 카드 업데이트
                await updateDashboardStats();
                
                // 차트 생성
                createEquipmentChart();
                await createRepairsChart({});
            
            // 테이블 업데이트
                updateNextWeekUptimeTable();
                updateRecentRepairsTable([]);
                updateAlertsTable();
            
            // 마지막 업데이트 시간
                const lastUpdatedElement = document.getElementById('last-updated');
                if (lastUpdatedElement) {
                    lastUpdatedElement.textContent = new Date().toLocaleString('ko-KR');
                }
                
                console.log('기본 대시보드 데이터 로드 완료');
                
            } catch (error) {
                console.error('기본 대시보드 데이터 로드 오류:', error);
            }
        }
        
        // 대시보드 통계 업데이트
        async function updateDashboardStats() {
            try {
                console.log('대시보드 통계 업데이트 시작...');
                
                // 1. 총 수리기록: 현재 전체 대기장비 가동률
                const equipmentResponse = await safeFetch('db/equipment_data.json');
                const equipmentData = await equipmentResponse.json();
                
                const totalEquipment = equipmentData.length;
                const operatingEquipment = equipmentData.filter(e => normalizeStatus(e.상태) === '가동 중').length;
                const uptimeRate = totalEquipment > 0 ? Math.round((operatingEquipment / totalEquipment) * 100) : 0;
                
                document.getElementById('total-equipment').textContent = `${totalEquipment} 대`;
                document.getElementById('total-repairs').textContent = `${uptimeRate}%`;
                
                // 2. 업체 수리중: equipment_data.json에서 현재위치가 '업체'인 장비 대수
                const companyRepairCount = equipmentData.filter(e => e.입고처 === '업체').length;
                document.getElementById('match-rate').textContent = `${companyRepairCount} 대`;
                console.log('업체 수리중 장비 수:', companyRepairCount);
                
                // 3. 총 수리 비용: 장기간(3개월 이상) 출장기록이 없는 장비 대수를 확률로 표시
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                
                let longTermInactiveCount = 0;
                equipmentData.forEach(equipment => {
                    if (equipment.날짜) {
                        const lastDate = new Date(equipment.날짜);
                        if (lastDate < threeMonthsAgo) {
                            longTermInactiveCount++;
                        }
                    }
                });
                
                const inactiveRate = totalEquipment > 0 ? Math.round((longTermInactiveCount / totalEquipment) * 100) : 0;
                document.getElementById('total-cost').textContent = `${inactiveRate}%`;
                
                console.log('대시보드 통계 업데이트 완료:', {
                    totalEquipment,
                    uptimeRate,
                    inactiveRate
                });
                
            } catch (error) {
                console.error('대시보드 통계 업데이트 오류:', error);
                // 오류 시 기본값 설정
                document.getElementById('total-equipment').textContent = '293 대';
                document.getElementById('total-repairs').textContent = '0%';
                document.getElementById('match-rate').textContent = '0 대';
                document.getElementById('total-cost').textContent = '0%';
            }
        }
        
        // 품목계열별 가동률 차트
        async function createEquipmentChart() {
            const ctx = document.getElementById('equipmentChart');
            if (!ctx) return;
            
            // 기존 차트 제거
            if (window.equipmentChart && typeof window.equipmentChart.destroy === 'function') {
                window.equipmentChart.destroy();
            }
            
            try {
                // equipment_data.json에서 품목계열별 가동률 계산
                const equipmentResponse = await safeFetch('db/equipment_data.json');
                const equipmentData = await equipmentResponse.json();
                
                // 품목계열별 통계 계산
                const productSeriesStats = {};
                equipmentData.forEach(equipment => {
                    const productSeries = equipment.품목계열 || '알 수 없음';
                    if (!productSeriesStats[productSeries]) {
                        productSeriesStats[productSeries] = {
                            total: 0,
                            operating: 0,
                            repair: 0,
                            standby: 0
                        };
                    }
                    
                    productSeriesStats[productSeries].total++;
                    
                    // 상태별 분류 (표준화 기반)
                    const statusNorm = normalizeStatus(equipment.상태);
                    if (statusNorm === '가동 중') {
                        productSeriesStats[productSeries].operating++;
                    } else if (statusNorm === '수리 중') {
                        productSeriesStats[productSeries].repair++;
                    } else {
                        productSeriesStats[productSeries].standby++;
                    }
                });
                
                // 가동률 계산 및 상위 10개 선택
                const uptimeData = Object.entries(productSeriesStats)
                    .map(([series, stats]) => ({
                        series,
                        uptime: stats.total > 0 ? Math.round((stats.operating / stats.total) * 100) : 0,
                        total: stats.total,
                        operating: stats.operating,
                        repair: stats.repair,
                        standby: stats.standby
                    }))
                    .filter(item => item.total >= 3) // 최소 3대 이상인 품목계열만
                    .sort((a, b) => b.uptime - a.uptime)
                    .slice(0, 10);
                
                // 차트 데이터 생성
                const labels = uptimeData.map(item => item.series);
                const uptimeValues = uptimeData.map(item => item.uptime);
                const totalValues = uptimeData.map(item => item.total);
                
                window.equipmentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '가동률 (%)',
                                data: uptimeValues,
                                backgroundColor: '#10B981',
                                borderColor: '#059669',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '총 장비 수',
                                data: totalValues,
                                backgroundColor: '#3B82F6',
                                borderColor: '#2563EB',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '가동률 (%)'
                                },
                                min: 0,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '장비 수 (대)'
                                },
                                min: 0,
                                grid: {
                                    drawOnChartArea: false,
                                },
                            },
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    afterBody: function(context) {
                                        const index = context[0].dataIndex;
                                        const series = labels[index];
                                        const uptime = uptimeValues[index];
                                        const total = totalValues[index];
                                        const operating = uptimeData[index].operating;
                                        const repair = uptimeData[index].repair;
                                        const standby = uptimeData[index].standby;
                                        return [
                                            `품목계열: ${series}`,
                                            `가동률: ${uptime}%`,
                                            `총 장비: ${total}대`,
                                            `가동중: ${operating}대`,
                                            `수리중: ${repair}대`,
                                            `대기중: ${standby}대`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('품목계열별 가동률 차트 생성 오류:', error);
                // 오류 시 기본 차트 표시
                createBasicEquipmentChart();
            }
        }
        
        // 기본 장비 차트 (오류 시 사용)
        async function createBasicEquipmentChart() {
            const ctx = document.getElementById('equipmentChart');
            if (!ctx) return;
            
            try {
                // 기본 측정항목별 장비 분포 차트 표시
                const equipmentResponse = await safeFetch('db/equipment_data.json');
                const equipmentData = await equipmentResponse.json();
                
                // 측정항목별 통계 (품목계열에서 첫 번째 괄호 안의 내용 추출)
                const measurementStats = {};
                equipmentData.forEach(equipment => {
                    const productSeries = equipment.품목계열 || '';
                    const match = productSeries.match(/\(([^)]+)\)/);
                    const item = match ? match[1] : '알 수 없음';
                    measurementStats[item] = (measurementStats[item] || 0) + 1;
                });
                
                window.equipmentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(measurementStats),
                        datasets: [{
                            data: Object.values(measurementStats),
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                                '#4BC0C0'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('기본 차트 생성 오류:', error);
            }
        }
        
        // 수리업체별 수리 건수 차트
        async function createRepairsChart(data) {
            const ctx = document.getElementById('repairsChart');
            if (!ctx) return;
            
            // 기존 차트 제거
            if (window.repairsChart && typeof window.repairsChart.destroy === 'function') {
                window.repairsChart.destroy();
            }
            
            try {
                // repairs_db_clean.json에서 수리 데이터 로드
                const repairsResponse = await safeFetch('db/repairs_db_clean.json');
                if (repairsResponse.ok) {
                    const repairsData = await repairsResponse.json();
                    
                    // 수리업체별 통계 계산 (건수 + 총 수리금액)
            const companyStats = {};
                    repairsData.forEach(repair => {
                    const company = repair.repair_company || '알 수 없음';
                        if (!companyStats[company]) {
                            companyStats[company] = {
                                count: 0,
                                totalCost: 0
                            };
                        }
                        companyStats[company].count++;
                        companyStats[company].totalCost += repair.cost || 0;
                    });
                    
                    // 상위 10개 수리업체만 표시 (건수 기준)
                    const topCompanies = Object.entries(companyStats)
                        .sort(([,a], [,b]) => b.count - a.count)
                        .slice(0, 10);
                    
                    const chartLabels = topCompanies.map(([company]) => company);
                    const chartData = topCompanies.map(([,stats]) => stats.count);
                    const chartCosts = topCompanies.map(([,stats]) => stats.totalCost);
                    
                    console.log('수리업체별 통계:', topCompanies);
                    console.log('차트 데이터:', { labels: chartLabels, data: chartData, costs: chartCosts });
            
            window.repairsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                            labels: chartLabels,
                    datasets: [{
                        label: '수리 건수',
                                data: chartData,
                        backgroundColor: '#667eea',
                        borderColor: '#5a6fd8',
                                borderWidth: 1,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: '수리 건수'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: '#667eea',
                                    borderWidth: 1,
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const count = context.parsed.y;
                                            const totalCost = chartCosts[index];
                                            return [
                                                `수리 건수: ${count}건`,
                                                `총 수리금액: ${totalCost.toLocaleString()}원`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    throw new Error(`수리 데이터 로드 실패: ${repairsResponse.status}`);
                }
            } catch (error) {
                console.error('수리업체별 차트 생성 오류:', error);
                // 오류 시 빈 차트 생성
                window.repairsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['데이터 없음'],
                        datasets: [{
                            label: '수리 건수',
                            data: [0],
                            backgroundColor: '#e5e7eb',
                            borderColor: '#d1d5db',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            }
        }
        
        // 다음주 예상 가동률 테이블 업데이트
        async function updateNextWeekUptimeTable() {
            const tbody = document.getElementById('next-week-uptime-body');
            if (!tbody) return;
            
            try {
                console.log('다음주 예상 가동률 데이터 로드 시작...');
                const equipmentResponse = await safeFetch('db/equipment_data.json');
                
                if (!equipmentResponse.ok) {
                    throw new Error(`HTTP 오류! 상태: ${equipmentResponse.status}`);
                }
                
                const equipmentData = await equipmentResponse.json();
                console.log('장비 데이터 로드 성공:', equipmentData.length, '건');
                
                // 품목계열별 통계 계산
                const productSeriesStats = {};
                equipmentData.forEach(equipment => {
                    const productSeries = equipment.품목계열 || '알 수 없음';
                    if (!productSeriesStats[productSeries]) {
                        productSeriesStats[productSeries] = {
                            total: 0,
                            operating: 0,
                            repair: 0,
                            standby: 0
                        };
                    }
                    
                    productSeriesStats[productSeries].total++;
                    
                    const statusNorm = normalizeStatus(equipment.상태);
                    if (statusNorm === '가동 중') {
                        productSeriesStats[productSeries].operating++;
                    } else if (statusNorm === '수리 중') {
                        productSeriesStats[productSeries].repair++;
                    } else {
                        productSeriesStats[productSeries].standby++;
                    }
                });
                
                console.log('품목계열별 통계 계산 완료:', Object.keys(productSeriesStats).length, '개');
                
                // 다음주 예상 가동률 계산 (수리 완료 예정 장비 포함)
                const nextWeekData = Object.entries(productSeriesStats)
                    .map(([series, stats]) => {
                        const currentOperating = stats.operating;
                        const repairCompletion = Math.min(stats.repair, Math.floor(stats.repair * 0.3)); // 30% 수리 완료 예상
                        const nextWeekOperating = currentOperating + repairCompletion;
                        const uptime = stats.total > 0 ? Math.round((nextWeekOperating / stats.total) * 100) : 0;
                        
                        return {
                            series,
                            nextWeekOperating,
                            currentCheongmyeong: stats.total,
                            uptime
                        };
                    })
                    .filter(item => item.currentCheongmyeong >= 3) // 최소 3대 이상인 품목계열만
                    .sort((a, b) => b.uptime - a.uptime)
                    .slice(0, 10);
                
                console.log('다음주 예상 가동률 데이터 생성 완료:', nextWeekData.length, '개');
            
            tbody.innerHTML = '';
            
                nextWeekData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-200';
                row.innerHTML = `
                        <td class="py-2 text-sm text-gray-900">${item.series}</td>
                        <td class="py-2 text-sm text-center text-blue-600 font-medium">${item.nextWeekOperating}대</td>
                        <td class="py-2 text-sm text-center text-gray-600">${item.currentCheongmyeong}대</td>
                        <td class="py-2 text-sm text-center text-green-600 font-medium">${item.uptime}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log('다음주 예상 가동률 테이블 업데이트 완료');
                
            } catch (error) {
                console.error('다음주 예상 가동률 테이블 업데이트 오류:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-4 text-center">
                            <div class="text-gray-500 mb-2">데이터를 로드할 수 없습니다</div>
                            <div class="text-xs text-gray-400">오류: ${error.message}</div>
                            <button onclick="updateNextWeekUptimeTable()" class="mt-2 px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                다시 시도
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // 최근 수리 기록 테이블 업데이트
        function updateRecentRepairsTable(data) {
            const tbody = document.getElementById('recent-repairs-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">수리 기록이 없습니다</td></tr>';
                return;
            }
            
            data.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.repair_date || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${item.serial}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.repair_company}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.repair_type}</td>
                `;
            });
        }
        
        // 알림 테이블 업데이트
        async function updateAlertsTable() {
            try {
                // 임시 알림 데이터 (실제로는 알림 DB에서 가져와야 함)
                const mockAlerts = [
                    { time: '2025-01-27 14:30', series: '(PM-2.5) PMS-204', content: '유량 이상 감지', priority: '긴급', status: '미조치' },
                    { time: '2025-01-27 13:15', series: '(NOx, SOx) BMW-5000', content: '온도 센서 오류', priority: '높음', status: '미조치' },
                    { time: '2025-01-27 12:45', series: '(O3) Serinus10i', content: '램프 수명 경고', priority: '보통', status: '미조치' },
                    { time: '2025-01-27 11:20', series: '(CO) Serinus30i', content: '교정 기간 만료', priority: '낮음', status: '미조치' }
                ];
                
                // 우선순위별 알림 수 카운트
                const priorityCounts = {
                    '긴급': 0,
                    '높음': 0,
                    '보통': 0,
                    '낮음': 0
                };
                
                mockAlerts.forEach(alert => {
                    if (priorityCounts.hasOwnProperty(alert.priority)) {
                        priorityCounts[alert.priority]++;
                    }
                });
                
                // 알림 카운트 업데이트
                document.getElementById('critical-alerts').textContent = priorityCounts['긴급'];
                document.getElementById('high-alerts').textContent = priorityCounts['높음'];
                document.getElementById('medium-alerts').textContent = priorityCounts['보통'];
                document.getElementById('low-alerts').textContent = priorityCounts['낮음'];
                
                // 알림 상세 테이블 업데이트
                const tbody = document.getElementById('alerts-body');
                if (tbody) {
                    tbody.innerHTML = '';
                    
                    mockAlerts.forEach(alert => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-slate-200';
                        
                        const priorityClass = {
                            '긴급': 'text-red-600 font-medium',
                            '높음': 'text-orange-600 font-medium',
                            '보통': 'text-yellow-600 font-medium',
                            '낮음': 'text-blue-600 font-medium'
                        }[alert.priority] || 'text-gray-600';
                        
                        row.innerHTML = `
                            <td class="py-2 text-sm text-gray-900">${alert.time}</td>
                            <td class="py-2 text-sm text-gray-900">${alert.series}</td>
                            <td class="py-2 text-sm text-gray-900">${alert.content}</td>
                            <td class="py-2 text-sm text-center ${priorityClass}">${alert.priority}</td>
                            <td class="py-2 text-sm text-center text-red-600">${alert.status}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error('알림 테이블 업데이트 오류:', error);
            }
        }
        
        // 이카운트 동기화 상태 관리
        function refreshSyncStatus() {
            const syncStatus = document.getElementById('sync-status');
            const syncProgressBar = document.getElementById('sync-progress-bar');
            const syncProgressText = document.getElementById('sync-progress-text');
            const lastSyncTime = document.getElementById('last-sync-time');
            
            // 동기화 상태 업데이트 (실제로는 API 호출)
            const now = new Date();
            lastSyncTime.textContent = now.toLocaleString('ko-KR');
            
            // 진행률 애니메이션
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    // 완료 상태로 변경
                    syncStatus.innerHTML = `
                        <svg class="w-2 h-2 mr-1.5" fill="currentColor" viewBox="0 0 8 8">
                            <circle cx="4" cy="4" r="3"/>
                        </svg>
                        완료
                    `;
                    syncStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                }
                
                syncProgressBar.style.width = progress + '%';
                syncProgressText.textContent = Math.round(progress) + '%';
            }, 200);
        }
        
        // 페이지 로드 시 대시보드 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료');
            
            // 모달 강제로 숨기기
            const modal = document.getElementById('purchase-request-modal');
            if (modal) {
                modal.classList.remove('show');
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
            
            // 초기 동기화 상태 설정
            const lastSyncTime = document.getElementById('last-sync-time');
            if (lastSyncTime) {
                lastSyncTime.textContent = new Date().toLocaleString('ko-KR');
            }
            
            // 대시보드가 기본 뷰이므로 기본 데이터 로드
            if (document.getElementById('dashboard-view')) {
                console.log('대시보드 뷰 감지, 기본 데이터 로드 시작');
                loadDefaultDashboardData();
            }

            // 수리 탭 통계/로그 즉시 로드(탭 비활성 상태여도 데이터 선로딩)
            try { loadRepairVisibilityStats(); } catch(e) { console.warn(e); }
            try { loadRepairLogTable().then(buildRepairCategoryGrid); } catch(e) { console.warn(e); }

            // 장비 검색 테이블 초기 렌더
            try { renderEquipmentTable(); } catch(e) { /* no-op */ }
        });
        
        // 뷰 전환 함수는 scripts/fetch_data.js에서 처리
        
        // 견적서 모달 제어
        function showQuoteForm() {
            const m = document.getElementById('quote-modal');
            if (m) m.classList.remove('hidden');
        }
        function closeQuoteModal() {
            const m = document.getElementById('quote-modal');
            if (m) m.classList.add('hidden');
        }

        // 숫자 유틸
        function toNumber(value) {
            if (value == null) return 0;
            const s = String(value).replace(/[^\d.-]/g, '');
            const n = parseFloat(s);
            return isNaN(n) ? 0 : n;
        }
        function formatKRW(n) {
            return (Math.round(n)).toLocaleString('ko-KR') + '원';
        }

        // 품목 행 합계/전체 합계 갱신
        function recalcQuoteTotals() {
            const tbody = document.getElementById('quote-items-table-body');
            if (!tbody) return;
            let supply = 0;
            tbody.querySelectorAll('tr').forEach(row => {
                const qty = toNumber(row.querySelector('td:nth-child(4) input')?.value || 0);
                const unit = toNumber(row.querySelector('td:nth-child(5) input')?.value || 0);
                const amountInput = row.querySelector('td:nth-child(6) input');
                const amount = qty * unit;
                if (amountInput) amountInput.value = formatKRW(amount);
                supply += amount;
            });
            const vat = Math.round(supply * 0.1);
            const total = supply + vat;
            const supplyEl = document.getElementById('supply-amount');
            const vatEl = document.getElementById('quote-vat');
            const totalEl = document.getElementById('quote-total-amount');
            if (supplyEl) { supplyEl.value = formatKRW(supply); supplyEl.dataset.value = String(supply); }
            if (vatEl) { vatEl.value = formatKRW(vat); vatEl.dataset.value = String(vat); }
            if (totalEl) { totalEl.value = formatKRW(total); totalEl.dataset.value = String(total); }
            const totalKorEl = document.getElementById('total-amount-korean');
            const totalNumEl = document.getElementById('total-amount-numeric');
            if (totalKorEl && !totalKorEl.readOnly) {
                // 사용자가 직접 타이핑 가능 유지: 자동 덮어쓰지 않음
            }
            if (totalNumEl) totalNumEl.value = `( ${total.toLocaleString('ko-KR')} )`;
        }

        // 행 추가/삭제
        function addQuoteItemRow() {
            const tbody = document.getElementById('quote-items-table-body');
            const index = tbody.children.length + 1;
            const tr = document.createElement('tr');
            tr.className = 'quote-item-row';
            tr.innerHTML = `
                <td class="border border-gray-300 px-3 py-2 text-center">${index}</td>
                <td class="border border-gray-300 px-3 py-2"><input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="제품번호"></td>
                <td class="border border-gray-300 px-3 py-2"><input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="세부내용"></td>
                <td class="border border-gray-300 px-3 py-2"><input type="number" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="수량" min="1" value="1"></td>
                <td class="border border-gray-300 px-3 py-2"><input type="number" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="단가" min="0" value="0"></td>
                <td class="border border-gray-300 px-3 py-2"><input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" readonly></td>
                <td class="border border-gray-300 px-3 py-2"><input type="text" class="w-full px-2 py-1 border-0 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="납기"></td>
                <td class="border border-gray-300 px-3 py-2 text-center">
                    <button type="button" onclick="removeQuoteItemRow(this)" class="text-red-600 hover:text-red-800 px-2 py-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </td>`;
            tbody.appendChild(tr);
            bindQuoteInputs(tr);
            recalcQuoteTotals();
        }
        function removeQuoteItemRow(btn) {
            const row = btn.closest('tr');
            row?.parentElement?.removeChild(row);
            // 행 번호 재정렬
            const rows = document.querySelectorAll('#quote-items-table-body tr');
            rows.forEach((r, i) => { const c = r.querySelector('td:first-child'); if (c) c.textContent = String(i+1); });
            recalcQuoteTotals();
        }

        function bindQuoteInputs(scope) {
            const root = scope || document;
            root.querySelectorAll('#quote-items-table-body tr td:nth-child(4) input, #quote-items-table-body tr td:nth-child(5) input').forEach(inp => {
                inp.addEventListener('input', recalcQuoteTotals);
                inp.addEventListener('change', recalcQuoteTotals);
            });
        }
        bindQuoteInputs();

        function printQuote() {
            window.print();
        }

        // ===== 장비 검색/필터/탭 렌더 =====
        let __equipmentAll = [];
        let __equipmentSeriesFilter = 'all';
        async function ensureEquipmentData() {
            if (__equipmentAll.length) return __equipmentAll;
            try {
                const res = await safeFetch('db/equipment_data.json');
                if (!res.ok) throw new Error('equipment_data.json not found');
                const rows = await res.json();
                __equipmentAll = rows.map(r => ({
                    serial: r.일련번호 || r.serial || '',
                    series: r.품목계열 || r.category || '',
                    status: normalizeStatus(r.상태 || r.status || ''),
                    location: r.현재위치 || r.currentLocation || r.입고창고명 || r.출고창고명 || r.location || ''
                }));
            } catch (e) {
                console.warn('장비 데이터 로드 실패:', e);
                __equipmentAll = [];
            }
            buildProductSeriesTabs();
            return __equipmentAll;
        }

        function buildProductSeriesTabs() {
            const wrap = document.getElementById('product-series-tabs');
            if (!wrap || !__equipmentAll.length || wrap.dataset.built === '1') return;
            const series = Array.from(new Set(__equipmentAll.map(x => x.series).filter(Boolean))).sort();
            wrap.innerHTML = '';
            const mkBtn = (label, value) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'px-3 py-1 text-sm rounded border hover:bg-slate-50';
                btn.textContent = label;
                btn.dataset.value = value;
                btn.onclick = () => {
                    __equipmentSeriesFilter = value;
                    Array.from(wrap.children).forEach(c => c.classList.remove('bg-indigo-600','text-white'));
                    btn.classList.add('bg-indigo-600','text-white');
                    renderEquipmentTable();
                };
                return btn;
            };
            const allBtn = mkBtn('전체', 'all');
            allBtn.classList.add('bg-indigo-600','text-white');
            wrap.appendChild(allBtn);
            series.forEach(s => wrap.appendChild(mkBtn(s, s)));
            wrap.dataset.built = '1';
        }

        async function renderEquipmentTable() {
            await ensureEquipmentData();
            const q = (document.getElementById('equipment-search')?.value || '').toLowerCase();
            const statusSel = document.getElementById('status-filter');
            const status = statusSel ? statusSel.value : 'all';
            let rows = __equipmentAll;
            if (__equipmentSeriesFilter !== 'all') rows = rows.filter(r => r.series === __equipmentSeriesFilter);
            if (status !== 'all') rows = rows.filter(r => r.status === status);
            if (q) rows = rows.filter(r => [r.serial, r.series, r.location].some(v => String(v||'').toLowerCase().includes(q)));

            const tbody = document.getElementById('equipment-list-body');
            if (tbody) {
                const frag = document.createDocumentFragment();
                rows.slice(0, 500).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 truncate" title="${r.serial}">${r.serial}</td>
                        <td class="p-2 truncate" title="${r.series || ''}">${r.series || ''}</td>
                        <td class="p-2 whitespace-nowrap">${r.status || ''}</td>
                        <td class="p-2 truncate" title="${r.location || ''}">${r.location || ''}</td>
                        <td class="p-2 text-right"><button type="button" class="px-2 py-1 text-xs border rounded">보기</button></td>
                    `;
                    frag.appendChild(tr);
                });
                tbody.innerHTML = '';
                tbody.appendChild(frag);
            }
            const cnt = document.getElementById('equipment-result-count');
            if (cnt) cnt.textContent = `총 ${rows.length.toLocaleString()}개 장비`;
        }

        // ===== 수리 통계 개요 로드 =====
        async function loadRepairOverview() {
            const statusEl = document.getElementById('repairs-overview-status');
            const tbody = document.getElementById('repairs-overview-body');
            
            if (statusEl) statusEl.textContent = '로딩 중...';
            if (tbody) tbody.setAttribute('aria-busy', 'true');
            
            try {
                const response = await safeFetch('db/stats_repairs_overview.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // 카드 업데이트
                updateRepairOverviewCards(data.totals);
                
                // 테이블 업데이트 (상위 50개)
                updateRepairOverviewTable(data.bySerial.slice(0, 50));
                
                if (statusEl) statusEl.textContent = `최종 업데이트: ${new Date().toLocaleString('ko-KR')}`;
                
            } catch (error) {
                console.error('수리 통계 개요 로드 실패:', error);
                
                if (statusEl) statusEl.textContent = '로드 실패';
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="p-4 text-center text-red-500">
                                <div class="space-y-2">
                                    <div>데이터를 불러올 수 없습니다</div>
                                    <div class="text-xs text-red-400">${error.message}</div>
                                    <button onclick="loadRepairOverview()" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                        재시도
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } finally {
                if (tbody) tbody.setAttribute('aria-busy', 'false');
            }
        }

        function updateRepairOverviewCards(totals) {
            // 카드 값 업데이트
            const elements = {
                'cardTravelTotal': totals.travelCount,
                'cardRepairTotal': totals.repairCount,
                'cardSerialsTravel': totals.serialsWithTravel,
                'cardSerialsRepair': totals.serialsWithRepair
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el && typeof value === 'number') {
                    el.textContent = value.toLocaleString();
                }
            });
        }

        function updateRepairOverviewTable(bySerial) {
            const tbody = document.getElementById('repairs-overview-body');
            if (!tbody) return;
            
            if (!bySerial || bySerial.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">데이터가 없습니다</td></tr>';
                return;
            }
            
            const frag = document.createDocumentFragment();
            bySerial.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 border-b border-slate-100';
                tr.innerHTML = `
                    <td class="p-2 text-center text-slate-600">${index + 1}</td>
                    <td class="p-2 font-medium text-slate-800">${item.serial || '-'}</td>
                    <td class="p-2 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${(item.travelCount || 0).toLocaleString()}회
                        </span>
                    </td>
                    <td class="p-2 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${(item.repairCount || 0).toLocaleString()}회
                        </span>
                    </td>
                    <td class="p-2 text-sm text-slate-600">${item.lastDate || '-'}</td>
                `;
                frag.appendChild(tr);
            });
            
            tbody.innerHTML = '';
            tbody.appendChild(frag);
        }

        // 페이지 로드 시 수리 통계 개요 자동 로드
        document.addEventListener('DOMContentLoaded', () => {
            // 기존 로직...
            try { loadRepairOverview(); } catch(e) { console.warn('수리 통계 자동 로드 실패:', e); }
            
            // 장비 알림 자동 로드
            try { loadAllEquipmentAlerts(); } catch(e) { console.warn('장비 알림 자동 로드 실패:', e); }
        });

        // ===== 장비 알림 시스템 =====
        let __allAlerts = [];
        let __alertCharts = {};

        // 모든 장비 알림 로드
        async function loadAllEquipmentAlerts() {
            try {
                await Promise.all([
                    loadVendorLongstayAlerts(),
                    loadCalibrationAlerts(),
                    loadMaintenanceScheduleAlerts(),
                    loadLifecycleReplacementAlerts()
                ]);
                
                // 통합 알림 목록 생성
                createUnifiedAlertsList();
                
                // 통계 차트 업데이트
                updateAlertStatistics();
                
                // 필터 이벤트 바인딩
                bindAlertFilterEvents();
                
            } catch (error) {
                console.error('장비 알림 로드 실패:', error);
                showAlertError('알림 데이터를 불러올 수 없습니다', error.message);
            }
        }

        // 장기간 업체 입고 알림 로드
        async function loadVendorLongstayAlerts() {
            try {
                const response = await safeFetch('db/equipment_db.json');
                if (!response.ok) throw new Error('equipment_db.json 로드 실패');
                
                const equipment = await response.json();
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                const longstayAlerts = equipment
                    .filter(item => {
                        const lastMoveDate = new Date(item.최근이동일 || item.lastMoveDate || '');
                        return !isNaN(lastMoveDate) && lastMoveDate < thirtyDaysAgo;
                    })
                    .map(item => ({
                        type: 'vendor-longstay',
                        priority: 'warning',
                        title: '장기간 업체 입고',
                        message: `${item.일련번호 || item.serial} 장비가 30일 이상 업체에 머물고 있습니다`,
                        equipment: item.일련번호 || item.serial,
                        date: item.최근이동일 || item.lastMoveDate,
                        details: {
                            location: item.현재위치 || item.currentLocation,
                            days: Math.floor((now - new Date(item.최근이동일 || item.lastMoveDate)) / (1000 * 60 * 60 * 24))
                        }
                    }));
                
                __allAlerts.push(...longstayAlerts);
                renderVendorLongstayAlerts(longstayAlerts);
                
            } catch (error) {
                console.error('장기간 업체 입고 알림 로드 실패:', error);
            }
        }

        // 정도검사 알림 로드
        async function loadCalibrationAlerts() {
            try {
                const response = await safeFetch('db/QC_logs.json');
                if (!response.ok) throw new Error('QC_logs.json 로드 실패');
                
                const qcLogs = await response.json();
                const now = new Date();
                
                const calibrationAlerts = qcLogs
                    .filter(log => {
                        const nextDue = new Date(log.다음정도검사예정일 || log.nextCalibrationDate || '');
                        const daysUntilDue = Math.floor((nextDue - now) / (1000 * 60 * 60 * 24));
                        return !isNaN(nextDue) && daysUntilDue <= 90; // 90일 이내
                    })
                    .map(log => {
                        const nextDue = new Date(log.다음정도검사예정일 || log.nextCalibrationDate);
                        const daysUntilDue = Math.floor((nextDue - now) / (1000 * 60 * 60 * 24));
                        
                        let priority = 'info';
                        if (daysUntilDue <= 7) priority = 'urgent';
                        else if (daysUntilDue <= 30) priority = 'warning';
                        
                        return {
                            type: 'calibration',
                            priority: priority,
                            title: '정도검사 예정',
                            message: `${log.일련번호 || log.serial} 장비의 정도검사가 ${daysUntilDue}일 후에 예정되어 있습니다`,
                            equipment: log.일련번호 || log.serial,
                            date: log.다음정도검사예정일 || log.nextCalibrationDate,
                            details: {
                                daysUntilDue: daysUntilDue,
                                lastCalibration: log.정도검사일 || log.calibrationDate
                            }
                        };
                    });
                
                __allAlerts.push(...calibrationAlerts);
                renderCalibrationAlerts(calibrationAlerts);
                
            } catch (error) {
                console.error('정도검사 알림 로드 실패:', error);
            }
        }

        // 정기 점검 예정 알림 로드
        async function loadMaintenanceScheduleAlerts() {
            try {
                const response = await safeFetch('db/repairs_db_clean.json');
                if (!response.ok) throw new Error('repairs_db_clean.json 로드 실패');
                
                const repairs = await response.json();
                const now = new Date();
                
                // 수리 빈도 기반으로 정기 점검 예정일 계산
                const maintenanceAlerts = [];
                const equipmentMaintenance = {};
                
                repairs.forEach(repair => {
                    const serial = repair.일련번호 || repair.serial;
                    if (!equipmentMaintenance[serial]) {
                        equipmentMaintenance[serial] = {
                            count: 0,
                            lastRepair: null,
                            avgInterval: 0
                        };
                    }
                    
                    equipmentMaintenance[serial].count++;
                    const repairDate = new Date(repair.수리일자 || repair.repairDate);
                    if (!equipmentMaintenance[serial].lastRepair || repairDate > equipmentMaintenance[serial].lastRepair) {
                        equipmentMaintenance[serial].lastRepair = repairDate;
                    }
                });
                
                // 평균 수리 간격 계산 및 다음 점검 예정일 추정
                Object.entries(equipmentMaintenance).forEach(([serial, data]) => {
                    if (data.count >= 2 && data.lastRepair) {
                        const avgInterval = 180; // 기본 6개월
                        const nextMaintenance = new Date(data.lastRepair.getTime() + avgInterval * 24 * 60 * 60 * 1000);
                        const daysUntilMaintenance = Math.floor((nextMaintenance - now) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntilMaintenance <= 60) {
                            let priority = 'info';
                            if (daysUntilMaintenance <= 7) priority = 'urgent';
                            else if (daysUntilMaintenance <= 30) priority = 'warning';
                            
                            maintenanceAlerts.push({
                                type: 'maintenance',
                                priority: priority,
                                title: '정기 점검 예정',
                                message: `${serial} 장비의 정기 점검이 ${daysUntilMaintenance}일 후에 예정되어 있습니다`,
                                equipment: serial,
                                date: nextMaintenance.toISOString().split('T')[0],
                                details: {
                                    daysUntilMaintenance: daysUntilMaintenance,
                                    lastRepair: data.lastRepair.toISOString().split('T')[0],
                                    repairCount: data.count
                                }
                            });
                        }
                    }
                });
                
                __allAlerts.push(...maintenanceAlerts);
                renderMaintenanceScheduleAlerts(maintenanceAlerts);
                
            } catch (error) {
                console.error('정기 점검 예정 알림 로드 실패:', error);
            }
        }

        // 수명 주기 교체 예정 알림 로드
        async function loadLifecycleReplacementAlerts() {
            try {
                const response = await safeFetch('db/equipment_db.json');
                if (!response.ok) throw new Error('equipment_db.json 로드 실패');
                
                const equipment = await response.json();
                const now = new Date();
                
                const replacementAlerts = equipment
                    .filter(item => {
                        const purchaseDate = new Date(item.구매일자 || item.purchaseDate || '');
                        const expectedLifespan = 365 * 5; // 기본 5년
                        const replacementDate = new Date(purchaseDate.getTime() + expectedLifespan * 24 * 60 * 60 * 1000);
                        const daysUntilReplacement = Math.floor((replacementDate - now) / (1000 * 60 * 60 * 24));
                        
                        return !isNaN(purchaseDate) && daysUntilReplacement <= 365; // 1년 이내
                    })
                    .map(item => {
                        const purchaseDate = new Date(item.구매일자 || item.purchaseDate);
                        const expectedLifespan = 365 * 5; // 기본 5년
                        const replacementDate = new Date(purchaseDate.getTime() + expectedLifespan * 24 * 60 * 60 * 1000);
                        const daysUntilReplacement = Math.floor((replacementDate - now) / (1000 * 60 * 60 * 1000));
                        
                        let priority = 'info';
                        if (daysUntilReplacement <= 90) priority = 'urgent';
                        else if (daysUntilReplacement <= 180) priority = 'warning';
                        
                        return {
                            type: 'replacement',
                            priority: priority,
                            title: '수명 주기 교체 예정',
                            message: `${item.일련번호 || item.serial} 장비의 교체가 ${daysUntilReplacement}일 후에 예정되어 있습니다`,
                            equipment: item.일련번호 || item.serial,
                            date: replacementDate.toISOString().split('T')[0],
                            details: {
                                daysUntilReplacement: daysUntilReplacement,
                                purchaseDate: purchaseDate.toISOString().split('T')[0],
                                age: Math.floor((now - purchaseDate) / (1000 * 60 * 60 * 24))
                            }
                        };
                    });
                
                __allAlerts.push(...replacementAlerts);
                renderLifecycleReplacementAlerts(replacementAlerts);
                
            } catch (error) {
                console.error('수명 주기 교체 예정 알림 로드 실패:', error);
            }
        }

        // 통합 알림 목록 생성
        function createUnifiedAlertsList() {
            const container = document.getElementById('unified-alerts-container');
            if (!container) return;
            
            if (__allAlerts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="text-lg">현재 활성화된 알림이 없습니다</div>
                        <div class="text-sm mt-2">모든 장비가 정상 상태입니다</div>
                    </div>
                `;
                return;
            }
            
            // 우선순위별로 정렬
            const priorityOrder = { urgent: 0, warning: 1, info: 2 };
            const sortedAlerts = __allAlerts.sort((a, b) => {
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return new Date(a.date) - new Date(b.date);
            });
            
            const frag = document.createDocumentFragment();
            sortedAlerts.forEach(alert => {
                const alertEl = createAlertElement(alert);
                frag.appendChild(alertEl);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        // 개별 알림 요소 생성
        function createAlertElement(alert) {
            const priorityColors = {
                urgent: 'border-red-200 bg-red-50 text-red-800',
                warning: 'border-orange-200 bg-orange-50 text-orange-800',
                info: 'border-blue-200 bg-blue-50 text-blue-800'
            };
            
            const priorityIcons = {
                urgent: '🔴',
                warning: '🟠',
                info: '🔵'
            };
            
            const div = document.createElement('div');
            div.className = `p-4 rounded-lg border ${priorityColors[alert.priority]} transition-all hover:shadow-md`;
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <span class="text-lg">${priorityIcons[alert.priority]}</span>
                        <div class="flex-1">
                            <div class="font-medium">${alert.title}</div>
                            <div class="text-sm mt-1">${alert.message}</div>
                            <div class="text-xs mt-2 opacity-75">
                                장비: ${alert.equipment} | 날짜: ${alert.date}
                            </div>
                        </div>
                    </div>
                    <button onclick="dismissAlert(this)" class="text-sm opacity-60 hover:opacity-100">
                        ✕
                    </button>
                </div>
            `;
            
            return div;
        }

        // 알림 차단
        function dismissAlert(button) {
            const alertEl = button.closest('div');
            alertEl.style.opacity = '0';
            setTimeout(() => alertEl.remove(), 300);
        }

        // 알림 통계 업데이트
        function updateAlertStatistics() {
            const urgentCount = __allAlerts.filter(a => a.priority === 'urgent').length;
            const warningCount = __allAlerts.filter(a => a.priority === 'warning').length;
            const infoCount = __allAlerts.filter(a => a.priority === 'info').length;
            
            const urgentEl = document.getElementById('urgent-alert-count');
            const warningEl = document.getElementById('warning-alert-count');
            const infoEl = document.getElementById('info-alert-count');
            
            if (urgentEl) urgentEl.textContent = urgentCount;
            if (warningEl) warningEl.textContent = warningCount;
            if (infoEl) infoEl.textContent = infoCount;
            
            // 차트 업데이트
            updateAlertCharts();
        }

        // 알림 차트 업데이트
        function updateAlertCharts() {
            // 알림 유형별 분포 차트
            updateAlertTypeChart();
            
            // 월별 알림 발생 추이 차트
            updateAlertTrendChart();
        }

        // 알림 유형별 분포 차트
        function updateAlertTypeChart() {
            const canvas = document.getElementById('alert-type-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 기존 차트 제거
            if (__alertCharts.typeChart) {
                __alertCharts.typeChart.destroy();
            }
            
            const typeCounts = {};
            __allAlerts.forEach(alert => {
                typeCounts[alert.type] = (typeCounts[alert.type] || 0) + 1;
            });
            
            const labels = Object.keys(typeCounts).map(type => {
                const typeNames = {
                    'vendor-longstay': '장기 입고',
                    'calibration': '정도검사',
                    'maintenance': '정기 점검',
                    'replacement': '교체 예정'
                };
                return typeNames[type] || type;
            });
            
            const data = Object.values(typeCounts);
            const colors = ['#EF4444', '#F59E0B', '#3B82F6', '#10B981'];
            
            __alertCharts.typeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // 월별 알림 발생 추이 차트
        function updateAlertTrendChart() {
            const canvas = document.getElementById('alert-trend-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 기존 차트 제거
            if (__alertCharts.trendChart) {
                __alertCharts.trendChart.destroy();
            }
            
            // 최근 6개월 데이터
            const months = [];
            const urgentData = [];
            const warningData = [];
            const infoData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = date.toISOString().slice(0, 7);
                months.push(date.toLocaleDateString('ko-KR', { month: 'short' }));
                
                const monthAlerts = __allAlerts.filter(alert => {
                    const alertDate = new Date(alert.date);
                    return alertDate.toISOString().slice(0, 7) === monthKey;
                });
                
                urgentData.push(monthAlerts.filter(a => a.priority === 'urgent').length);
                warningData.push(monthAlerts.filter(a => a.priority === 'warning').length);
                infoData.push(monthAlerts.filter(a => a.priority === 'info').length);
            }
            
            __alertCharts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '긴급',
                            data: urgentData,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '경고',
                            data: warningData,
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '정보',
                            data: infoData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // 알림 필터 이벤트 바인딩
        function bindAlertFilterEvents() {
            const priorityFilter = document.getElementById('priority-filter');
            const sortFilter = document.getElementById('sort-filter');
            
            if (priorityFilter) {
                priorityFilter.addEventListener('change', filterAlerts);
            }
            
            if (sortFilter) {
                sortFilter.addEventListener('change', filterAlerts);
            }
        }

        // 알림 필터링
        function filterAlerts() {
            const priorityFilter = document.getElementById('priority-filter');
            const sortFilter = document.getElementById('sort-filter');
            
            if (!priorityFilter || !sortFilter) return;
            
            let filteredAlerts = [...__allAlerts];
            
            // 우선순위 필터
            if (priorityFilter.value !== 'all') {
                filteredAlerts = filteredAlerts.filter(alert => alert.priority === priorityFilter.value);
            }
            
            // 정렬
            switch (sortFilter.value) {
                case 'priority':
                    const priorityOrder = { urgent: 0, warning: 1, info: 2 };
                    filteredAlerts.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
                    break;
                case 'date':
                    filteredAlerts.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'equipment':
                    filteredAlerts.sort((a, b) => a.equipment.localeCompare(b.equipment));
                    break;
            }
            
            // 필터링된 결과 표시
            renderFilteredAlerts(filteredAlerts);
        }

        // 필터링된 알림 렌더링
        function renderFilteredAlerts(alerts) {
            const container = document.getElementById('unified-alerts-container');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="text-lg">필터 조건에 맞는 알림이 없습니다</div>
                        <div class="text-sm mt-2">필터를 조정해보세요</div>
                    </div>
                `;
                return;
            }
            
            const frag = document.createDocumentFragment();
            alerts.forEach(alert => {
                const alertEl = createAlertElement(alert);
                frag.appendChild(alertEl);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        // 개별 알림 섹션 렌더링 함수들
        function renderVendorLongstayAlerts(alerts) {
            const container = document.getElementById('vendor-longstay-alerts');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-4">장기간 업체 입고 장비가 없습니다</div>';
                return;
            }
            
            const frag = document.createDocumentFragment();
            alerts.forEach(alert => {
                const div = document.createElement('div');
                div.className = 'p-4 bg-orange-50 border border-orange-200 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium text-orange-800">${alert.equipment}</div>
                            <div class="text-sm text-orange-600 mt-1">${alert.details.location}</div>
                            <div class="text-xs text-orange-500 mt-1">${alert.details.days}일간 입고</div>
                        </div>
                        <div class="text-orange-400">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                `;
                frag.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        function renderCalibrationAlerts(alerts) {
            const container = document.getElementById('calibration-alerts');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-4">정도검사 예정인 장비가 없습니다</div>';
                return;
            }
            
            const frag = document.createDocumentFragment();
            alerts.forEach(alert => {
                const priorityColors = {
                    urgent: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-orange-50 border-orange-200 text-orange-800',
                    info: 'bg-blue-50 border-blue-200 text-blue-800'
                };
                
                const div = document.createElement('div');
                div.className = `p-4 border rounded-lg ${priorityColors[alert.priority]}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">${alert.equipment}</div>
                            <div class="text-sm mt-1">${alert.details.daysUntilDue}일 후 정도검사 예정</div>
                            <div class="text-xs mt-1 opacity-75">마지막: ${alert.details.lastCalibration}</div>
                        </div>
                        <div class="text-2xl">
                            ${alert.details.daysUntilDue <= 7 ? '🔴' : alert.details.daysUntilDue <= 30 ? '🟠' : '🔵'}
                        </div>
                    </div>
                `;
                frag.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        function renderMaintenanceScheduleAlerts(alerts) {
            const container = document.getElementById('maintenance-schedule-alerts');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-4">정기 점검 예정인 장비가 없습니다</div>';
                return;
            }
            
            const frag = document.createDocumentFragment();
            alerts.forEach(alert => {
                const priorityColors = {
                    urgent: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-orange-50 border-orange-200 text-orange-800',
                    info: 'bg-blue-50 border-blue-200 text-blue-800'
                };
                
                const div = document.createElement('div');
                div.className = `p-3 border rounded-lg ${priorityColors[alert.priority]} text-sm`;
                div.innerHTML = `
                    <div class="font-medium">${alert.equipment}</div>
                    <div class="mt-1">${alert.details.daysUntilMaintenance}일 후 점검</div>
                    <div class="text-xs mt-1 opacity-75">수리 ${alert.details.repairCount}회</div>
                `;
                frag.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        function renderLifecycleReplacementAlerts(alerts) {
            const container = document.getElementById('lifecycle-replacement-alerts');
            if (!container) return;
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-4">교체 예정인 장비가 없습니다</div>';
                return;
            }
            
            const frag = document.createDocumentFragment();
            alerts.forEach(alert => {
                const priorityColors = {
                    urgent: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-orange-50 border-orange-200 text-orange-800',
                    info: 'bg-blue-50 border-blue-200 text-blue-800'
                };
                
                const div = document.createElement('div');
                div.className = `p-3 border rounded-lg ${priorityColors[alert.priority]} text-sm`;
                div.innerHTML = `
                    <div class="font-medium">${alert.equipment}</div>
                    <div class="mt-1">${alert.details.daysUntilReplacement}일 후 교체</div>
                    <div class="text-xs mt-1 opacity-75">사용 ${alert.details.age}일</div>
                `;
                frag.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(frag);
        }

        // 알림 오류 표시
        function showAlertError(title, message) {
            const container = document.getElementById('unified-alerts-container');
            if (container) {
                container.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <div class="text-lg">${title}</div>
                        <div class="text-sm mt-2">${message}</div>
                        <button onclick="loadAllEquipmentAlerts()" class="mt-4 px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200">
                            재시도
                        </button>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>